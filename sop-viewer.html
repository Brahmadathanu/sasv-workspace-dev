<!DOCTYPE html>
<html lang="en-GB">
  <head>
    <meta charset="UTF-8" />
    <title>SOP Viewer | SASV WORKSPACE</title>
    <link rel="stylesheet" href="public/shared/css/style.css" />
    <style>
      /* ---------- Layout: header ---------- */
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 16px 0;
      }

      /* ---------- Badges ---------- */
      .badges-row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin: 8px 0 12px;
      }
      .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
        color: #111827;
      }
      .badge.primary {
        background: #0a62c3;
        color: #fff;
        border-color: #084c99;
      }
      .badge.ok {
        background: #d1f7c4;
        color: #2f6f1a;
        border-color: #a7ec91;
      }
      .badge.warn {
        background: #fff3cd;
        color: #9a6b00;
        border-color: #ffe08a;
      }
      .badge.danger {
        background: #f8d7da;
        color: #842029;
        border-color: #f1aeb5;
      }
      .badges-row .badge {
        text-transform: capitalize;
      }

      /* ---------- Markdown body (viewer) ---------- */
      .md-body {
        background: var(--panel-bg, #fff);
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 16px;
        line-height: 1.55;
      }
      .md-body h1,
      .md-body h2,
      .md-body h3 {
        margin: 1em 0 0.4em;
      }
      .md-body p {
        margin: 0.6em 0;
      }
      .md-body ul,
      .md-body ol {
        margin: 0.6em 0 0.6em 1.4em;
      }
      .md-body code {
        padding: 0 4px;
        border-radius: 4px;
        background: #f3f4f6;
      }
      .md-body pre {
        padding: 10px;
        border-radius: 6px;
        background: #111827;
        color: #f3f4f6;
        overflow: auto;
      }
      .md-body a {
        text-decoration: underline;
      }

      /* ---------- Meta card (viewer) ---------- */
      .meta-card {
        display: grid;
        grid-template-columns: repeat(
          3,
          minmax(220px, 1fr)
        ); /* default: 3 balanced cols */
        gap: 12px 24px;
        padding: 14px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background: #fff;
        margin-bottom: 16px;
        line-height: 1.7;
      }
      .meta-col > div {
        margin: 4px 0;
      }
      .meta-col strong {
        display: inline-block;
        min-width: 160px;
        color: #374151;
      }
      /* Sentence-case status */
      .meta-card #m_status {
        text-transform: capitalize;
      }

      /* Collapse meta to 1 column on small screens */
      @media (max-width: 680px) {
        .meta-card {
          grid-template-columns: 1fr;
        }
      }

      .sop-body {
        margin-top: 12px;
      }

      /* ---------- Export: link-style dropdown (ghost pill) ---------- */
      .export-group {
        position: relative;
      }

      .export-link {
        background: transparent;
        border: 1px solid transparent;
        color: #0a62c3;
        padding: 6px 10px;
        font: inherit;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: 999px;
        text-decoration: none; /* no underline */
        transition: background 160ms ease, border-color 160ms ease,
          box-shadow 160ms ease, transform 80ms ease;
      }
      .export-link:hover {
        background: #f2f7ff; /* subtle tint */
        border-color: #e0ebff; /* soft outline */
        box-shadow: inset 0 0 0 1px #e0ebff; /* ghost border */
        text-decoration: none; /* keep it off */
      }
      .export-link:active {
        transform: translateY(0.5px);
      }
      .export-link:focus-visible {
        outline: none;
        box-shadow: 0 0 0 2px #cfe0ff; /* accessible focus ring */
      }
      .export-link .caret {
        display: inline-block;
        transition: transform 160ms ease;
      }
      .export-link[aria-expanded="true"] .caret {
        transform: rotate(180deg);
      }

      .export-menu {
        position: absolute;
        right: 0;
        top: 100%;
        margin-top: 6px;
        min-width: 240px;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 8px 28px rgba(0, 0, 0, 0.08),
          0 2px 8px rgba(0, 0, 0, 0.06);
        padding: 6px;
        z-index: 1000;
      }
      .export-menu button[role="menuitem"] {
        width: 100%;
        text-align: left;
        background: transparent;
        border: 0;
        padding: 8px 10px;
        border-radius: 6px;
        font: inherit;
        color: #111827;
        cursor: pointer;
      }
      .export-menu button[role="menuitem"]:hover {
        background: #f3f4f6;
      }

      /* ---------- Helpers ---------- */
      [hidden] {
        display: none !important;
      }

      /* ---------- Print: hide interactive UI & badges ---------- */
      @media print {
        header button,
        header .sop-btn,
        .export-group,
        .badges-row {
          display: none !important;
        }
        body {
          background: #fff !important;
        }
        .md-body {
          border: none;
          padding: 0;
        }
      }
    </style>
  </head>
  <body data-theme="system">
    <header>
      <h1 id="pageTitle">SOP Viewer</h1>
      <div style="display: flex; gap: 8px; align-items: center">
        <!-- Export (link-style dropdown) -->
        <div class="export-group">
          <button
            id="exportMenuBtn"
            class="export-link"
            aria-haspopup="menu"
            aria-expanded="false"
            type="button"
          >
            Export <span class="caret" aria-hidden="true">▾</span>
          </button>

          <div id="exportMenu" class="export-menu" role="menu" hidden>
            <button type="button" role="menuitem" data-export="pdf">
              Export as PDF
            </button>
            <button type="button" role="menuitem" data-export="docx">
              Export as Word (.docx)
            </button>
            <button type="button" role="menuitem" data-export="html">
              Export as HTML
            </button>
            <button type="button" role="menuitem" data-export="md">
              Export as Markdown (.md)
            </button>
          </div>
        </div>

        <button id="homeBtn">HOME</button>
      </div>
    </header>

    <section class="panel">
      <div id="sopHeader">
        <h1 id="sopTitle">Loading…</h1>

        <div id="sopBadges" class="badges-row"></div>

        <div id="sopMeta" class="meta-card">
          <!-- Identity -->
          <div class="meta-col">
            <div><strong>SOP No.</strong> <span id="m_sop_no">—</span></div>
            <div><strong>Version</strong> <span id="m_version">—</span></div>
            <div><strong>Status</strong> <span id="m_status">—</span></div>
          </div>

          <!-- Lifecycle -->
          <div class="meta-col">
            <div><strong>Type</strong> <span id="m_type">—</span></div>
            <div><strong>Kind</strong> <span id="m_kind">—</span></div>
            <div><strong>Created on</strong> <span id="m_created">—</span></div>
          </div>

          <!-- People & recency -->
          <div class="meta-col">
            <div>
              <strong>Last updated on</strong> <span id="m_updated">—</span>
            </div>
            <div><strong>Author</strong> <span id="m_author">—</span></div>
            <div>
              <strong>Last Reviewer</strong> <span id="m_reviewer">—</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Single, final body container for rendered Markdown -->
      <div id="descBox" class="md-body">Loading…</div>
    </section>

    <script type="module" src="public/shared/js/supabaseClient.js"></script>
    <script type="module" src="js/sop-viewer.js"></script>
  </body>
</html>
