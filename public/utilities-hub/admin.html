<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <!-- PWA/meta -->
    <meta name="color-scheme" content="light" />
    <meta name="supported-color-schemes" content="light" />
    <meta name="theme-color" content="#ffffff" />
    <link rel="manifest" href="../manifest.webmanifest" />

    <!-- Styles -->
    <link rel="stylesheet" href="../shared/css/style.css" />

    <!-- Icons -->
    <link rel="icon" type="image/png" href="../icons/icon-192x192.png" />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="../icons/icon-192x192.png"
    />

    <title>Canonical Admin</title>

    <style>
      :root {
        --brand: #0a62c3;
        --brand-600: #084e9c;
        --border: #e5e7eb;
        --bg-soft: #f8fafc;
        --danger: #dc2626;
        --danger-hover: #b91c1c;
        --success: #16a34a;
        --warning: #f59e0b;
      }
      .wrap {
        max-width: min(1400px, 95vw);
        margin: 24px auto;
        padding: 0 12px 28px;
      }
      header.hdr {
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid var(--border);
      }
      .hdr-top {
        display: flex;
        align-items: center;
        gap: 12px;
        justify-content: space-between;
        margin-bottom: 8px;
      }
      .hdr h1 {
        margin: 0;
        font-size: clamp(1.2rem, 3.2vw, 1.7rem);
        color: var(--brand);
      }
      .button {
        appearance: none;
        border: 1px solid var(--border);
        background: #f7fafc;
        padding: 0.6rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }
      .button.primary {
        background: var(--brand);
        color: #fff;
        border-color: var(--brand);
      }
      .button.primary:hover {
        background: var(--brand-600);
        border-color: var(--brand-600);
      }
      .button.danger {
        background: var(--danger);
        color: #fff;
        border-color: var(--danger);
      }
      .button.danger:hover {
        background: var(--danger-hover);
        border-color: var(--danger-hover);
      }
      .button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      nav.tabs {
        display: flex;
        gap: 0;
        margin: 20px 0 0 0;
        border-bottom: 2px solid var(--border);
        position: relative;
      }
      nav.tabs button {
        border: 1px solid var(--border);
        border-bottom: none;
        background: #fafbfc;
        padding: 14px 20px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        border-radius: 6px 6px 0 0;
        transition: all 0.2s;
        margin-right: 2px;
        color: #64748b;
        position: relative;
      }
      nav.tabs button:hover {
        background: #f1f5f9;
        color: #475569;
      }
      nav.tabs button.active {
        background: #fff;
        color: var(--brand);
        font-weight: 600;
        border-color: var(--border);
        z-index: 1;
        margin-bottom: -2px;
        border-bottom: 2px solid #fff;
      }
      nav.tabs button.active::after {
        content: "";
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 2px;
        background: #fff;
      }

      .panel {
        display: none;
        animation: fadeIn 0.3s ease;
      }
      .panel.active {
        display: block;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .card {
        border: 1px solid var(--border);
        border-radius: 12px;
        background: #fff;
        padding: 18px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      }
      .card h3 {
        margin: 0 0 14px;
        color: var(--brand);
        font-size: 1.1rem;
      }

      .controls {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 16px;
        align-items: center;
      }
      input[type="text"],
      input[type="email"],
      select,
      textarea {
        height: 42px;
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.2s;
      }
      textarea {
        height: 80px;
        resize: vertical;
      }
      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--brand);
        box-shadow: 0 0 0 3px rgba(10, 98, 195, 0.1);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
        font-size: 14px;
      }
      th,
      td {
        border: 1px solid var(--border);
        padding: 10px 12px;
        text-align: left;
      }
      th {
        background: var(--bg-soft);
        font-weight: 600;
        color: var(--brand);
      }
      tbody tr:hover {
        background: #f9fbff;
      }

      .status {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 500;
      }
      .status.active {
        background: #dcfce7;
        color: var(--success);
      }
      .status.pending {
        background: #fef3c7;
        color: var(--warning);
      }
      .status.denied {
        background: #fee2e2;
        color: var(--danger);
      }

      .audit-log {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid var(--border);
        border-radius: 8px;
      }

      /* utility hidden helper */
      .hidden {
        display: none !important;
      }

      /* Make monitor/results tables responsive on small screens */
      #monitor-results {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      #monitor-results table {
        min-width: 640px; /* allow horizontal scroll rather than overflow */
      }

      @media (max-width: 640px) {
        th,
        td {
          padding: 8px 6px;
          font-size: 13px;
        }
      }

      .alert {
        padding: 12px 16px;
        border-radius: 8px;
        margin: 12px 0;
      }
      .alert.info {
        background: #e0f2fe;
        border: 1px solid #0ea5e9;
        color: #0c4a6e;
      }
      .alert.error {
        background: #fee2e2;
        border: 1px solid var(--danger);
        color: #7f1d1d;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #6b7280;
      }

      @media (prefers-color-scheme: dark) {
        .card {
          background: #0b0f14;
          border-color: #1f2937;
        }
        .status.active {
          background: #064e3b;
          color: #10b981;
        }
        table th {
          background: #0f1823;
        }
        tbody tr:hover {
          background: #0f1420;
        }
        input,
        select,
        textarea {
          background: #0f172a;
          border-color: #243244;
          color: #e5e7eb;
        }
      }

      /* Platform-aware HOME Button */
      #homeBtn {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        border: 1px solid #fdba74 !important;
        border-radius: 6px;
        background: #fed7aa !important;
        color: #9a3412 !important;
        cursor: pointer;
        font-size: 0.875rem;
        font-family: inherit;
        font-weight: 500;
        transition: all 0.2s;
      }
      #homeBtn:hover {
        background: #fdba74 !important;
        border-color: #fb923c !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      #homeBtn svg {
        flex-shrink: 0;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <header class="hdr">
        <div class="hdr-top">
          <h1>Canonical Admin</h1>
          <div style="display: flex; gap: 8px; align-items: center">
            <span
              id="admin-user-info"
              style="font-size: 14px; color: #6b7280"
            ></span>
            <button id="homeBtn">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                <polyline points="9,22 9,12 15,12 15,22" />
              </svg>
              HOME
            </button>
          </div>
        </div>
        <p
          class="hint"
          style="margin: 4px 0 0 0; padding-left: 0; text-align: left"
        >
          Canonical console for grants, revocations, and auditing of user
          access.
        </p>
      </header>

      <!-- Toast area: isolated from admin-guard and page alerts -->
      <div id="toast-area" aria-live="polite"></div>

      <div id="admin-guard" class="alert error" style="display: none">
        <strong>Access Denied:</strong> You need admin privileges to access this
        module.
      </div>

      <nav class="tabs" role="tablist" aria-label="Admin sections">
        <button class="active" data-tab="users" role="tab" aria-selected="true">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
            aria-hidden="true"
            style="
              vertical-align: middle;
              margin-right: 6px;
              color: var(--brand);
              flex-shrink: 0;
            "
          >
            <rect
              x="3"
              y="11"
              width="18"
              height="10"
              rx="2"
              stroke="currentColor"
              stroke-width="1.4"
              fill="none"
            />
            <circle cx="12" cy="16" r="1" fill="currentColor" />
            <path
              d="M7 11V7a5 5 0 0 1 10 0v4"
              stroke="currentColor"
              stroke-width="1.4"
              fill="none"
              stroke-linecap="round"
            />
          </svg>
          User Access
        </button>
        <button data-tab="monitor" role="tab" aria-selected="false">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
            aria-hidden="true"
            style="
              vertical-align: middle;
              margin-right: 6px;
              color: var(--brand);
              flex-shrink: 0;
            "
          >
            <path
              d="M3 3v18h18"
              stroke="currentColor"
              stroke-width="1.4"
              fill="none"
            />
            <rect x="6" y="12" width="2" height="6" fill="currentColor" />
            <rect x="10" y="8" width="2" height="10" fill="currentColor" />
            <rect x="14" y="4" width="2" height="14" fill="currentColor" />
          </svg>
          Access Monitor
        </button>
        <button data-tab="audit" role="tab" aria-selected="false">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
            aria-hidden="true"
            style="
              vertical-align: middle;
              margin-right: 6px;
              color: var(--brand);
              flex-shrink: 0;
            "
          >
            <rect
              x="3"
              y="3"
              width="18"
              height="18"
              rx="2"
              stroke="currentColor"
              stroke-width="1.4"
              fill="none"
            />
            <path
              d="M7 8h10M7 12h10M7 16h6"
              stroke="currentColor"
              stroke-width="1.4"
              stroke-linecap="round"
            />
          </svg>
          Audit Log
        </button>
      </nav>

      <!-- User Access Management -->
      <section id="panel-users" class="panel active" role="tabpanel">
        <div class="card">
          <h3>Grant Access</h3>
          <div class="controls">
            <input
              id="grant-email"
              list="userEmails"
              type="email"
              placeholder="user@company.com"
              style="min-width: 250px"
              required
            />
            <datalist id="userEmails"></datalist>
            <select id="grant-utility" required>
              <option value="">Select Module/Role...</option>
            </select>
            <div style="font-size: 12px; color: #6b7280; width: 100%">
              Modules = screen access; Roles = capability bundles.
            </div>
            <select id="grant-level" required>
              <option value="view">View Only</option>
              <option value="use">Full Use</option>
            </select>
            <button id="grantBtn" class="button primary">Grant Access</button>
          </div>
          <textarea
            id="grant-reason"
            placeholder="Reason for access grant (optional)"
            style="width: 100%; margin-bottom: 10px"
          ></textarea>
        </div>

        <div class="card">
          <h3>Lookup User Access</h3>
          <div class="controls">
            <input
              id="lookup-email"
              list="userEmails"
              type="email"
              placeholder="user@company.com"
              style="min-width: 250px"
            />
            <button id="lookupBtn" class="button">Load Access</button>
          </div>
          <div id="user-access-results">
            <!-- Dynamic table will appear here -->
          </div>
        </div>

        <div class="card" id="card-target-access">
          <h3>Lookup Module/Role Access</h3>
          <div class="controls">
            <select id="target-lookup-select" style="min-width: 320px">
              <option value="">Select Module/Role…</option>
            </select>

            <button id="targetLookupBtn" class="button">Load Users</button>

            <input
              id="target-user-search"
              type="text"
              placeholder="Filter by email or user id…"
              style="min-width: 260px"
            />

            <span class="status info hidden" id="target-lookup-stats"
              >Idle</span
            >
          </div>

          <div id="target-access-results"></div>
        </div>
      </section>

      <!-- Access Monitor -->
      <section id="panel-monitor" class="panel" role="tabpanel">
        <div class="card">
          <h3>
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
              aria-hidden="true"
              style="vertical-align: middle; margin-right: 6px"
            >
              <circle
                cx="12"
                cy="12"
                r="9"
                stroke="#0a62c3"
                stroke-width="1.2"
              />
            </svg>
            System Access Overview
          </h3>
          <div class="controls">
            <input
              id="monitor-search"
              placeholder="Search by email or user id…"
              style="
                min-width: 260px;
                padding: 8px;
                border-radius: 8px;
                border: 1px solid var(--border);
              "
            />
            <button id="refreshMonitor" class="button">
              <svg
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                aria-hidden="true"
              >
                <path
                  d="M21 12a9 9 0 1 0-3 6.7"
                  stroke="#0a62c3"
                  stroke-width="1.6"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              Refresh
            </button>
            <span class="status info" id="monitor-stats">Loading...</span>
          </div>
          <div id="monitor-results">
            <!-- Live access stats will appear here -->
          </div>
        </div>
      </section>

      <!-- Audit Log -->
      <section id="panel-audit" class="panel" role="tabpanel">
        <div class="card">
          <h3>
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
              aria-hidden="true"
              style="vertical-align: middle; margin-right: 6px"
            >
              <rect
                x="3"
                y="4"
                width="18"
                height="16"
                rx="2"
                stroke="#0a62c3"
                stroke-width="1.2"
              />
              <path d="M8 8h8" stroke="#0a62c3" stroke-width="1.2" />
            </svg>
            Admin Action Audit
          </h3>
          <div class="controls">
            <button id="refreshAudit" class="button">Refresh</button>
            <input
              id="audit-search"
              placeholder="Search by email, user id, details…"
              style="
                min-width: 260px;
                padding: 8px;
                border-radius: 8px;
                border: 1px solid var(--border);
              "
            />
            <select id="audit-filter">
              <option value="">All Actions</option>
              <option value="grant">Grants</option>
              <option value="revoke">Revocations</option>
              <option value="modify">Modifications</option>
            </select>
          </div>
          <div class="audit-log" id="audit-log-container">
            <div class="loading">Loading audit logs...</div>
          </div>
        </div>
      </section>
    </div>

    <!-- Load the canonical admin controller -->
    <script type="module" src="./js/admin.js"></script>
  </body>
</html>
