<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Signing you in…</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: system-ui, Arial, sans-serif;
        margin: 24px;
        color: #0b1420;
      }
      .card {
        max-width: 560px;
        margin: 12vh auto 0;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 18px;
        background: #fff;
      }
      h1 {
        font-size: 1.25rem;
        margin: 0.2rem 0;
      }
      p {
        color: #475569;
        margin: 0.4rem 0;
      }
      button {
        margin-top: 8px;
        padding: 0.6rem 1rem;
        border-radius: 8px;
        border: 1px solid #0a62c3;
        background: #0a62c3;
        color: #fff;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Signing you in…</h1>
      <p>
        If the app is installed, it should open automatically. You can close
        this tab after it does.
      </p>
      <button id="open">Open SASV Utilities Hub</button>
    </div>

      <script type="module">
        import { supabase } from "../../shared/js/supabaseClient.js";

        const card = document.querySelector(".card");

        function broadcastSignedIn() {
          // 1) Ask SW to wake/focus the PWA
          if ("serviceWorker" in navigator) {
            navigator.serviceWorker.ready
              .then((reg) => (reg.active || navigator.serviceWorker.controller)?.postMessage({ type: "signed-in" }))
              .catch(() => {});
          }
          // 2) Also ping any open hub tab/window
          try {
            const bc = new BroadcastChannel("sasv-auth");
            bc.postMessage({ type: "signed-in" });
          } catch {}
        }

        function showResetForm() {
          const form = document.createElement("form");
          form.innerHTML = `
            <h2>Set a new password</h2>
            <p style="color:#475569;margin:0.4rem 0">Enter a new password to finish resetting.</p>
            <input id="new-pass" type="password" placeholder="New password" style="height:40px;padding:6px 10px;border:1px solid #e5e7eb;border-radius:8px;width:100%;margin-top:8px" />
            <button id="save-pass" type="submit" style="margin-top:10px;padding:0.6rem 1rem;border-radius:8px;border:1px solid #0a62c3;background:#0a62c3;color:#fff;cursor:pointer;">Save password</button>
            <p id="msg" style="margin-top:8px;color:#475569"></p>
          `;
          card.appendChild(form);

          const msg = form.querySelector("#msg");
          form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const pwd = form.querySelector("#new-pass").value;
            if (!pwd) { msg.textContent = "Enter a password."; return; }
            msg.textContent = "Updating…";
            try {
              const { error } = await supabase.auth.updateUser({ password: pwd });
              if (error) throw error;
              msg.textContent = "Password updated. You’re signed in.";
              broadcastSignedIn();
            } catch (err) {
              console.error(err);
              msg.textContent = "Could not update password. Try again.";
            }
          });
        }

        // If this is a password recovery link, show reset form
        const hash = location.hash || "";
        if (hash.includes("type=recovery")) {
          showResetForm();
        } else {
          // Normal magic/sign-in callback: just notify app and show button
          broadcastSignedIn();
        }

        // Manual fallback button
        document.getElementById("open")?.addEventListener("click", () => {
          location.href = "/utilities-hub/";
        });
      </script>
    </script>
  </body>
</html>
