<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Signing you in…</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: system-ui, Arial, sans-serif;
        margin: 24px;
        color: #0b1420;
      }
      .card {
        max-width: 560px;
        margin: 12vh auto 0;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 18px;
        background: #fff;
      }
      h1 {
        font-size: 1.25rem;
        margin: 0.2rem 0;
      }
      p {
        color: #475569;
        margin: 0.4rem 0;
      }
      button {
        margin-top: 8px;
        padding: 0.6rem 1rem;
        border-radius: 8px;
        border: 1px solid #0a62c3;
        background: #0a62c3;
        color: #fff;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Signing you in…</h1>
      <p>
        If the app is installed, it should open automatically. You can close
        this tab after it does.
      </p>
      <button id="open">Open SASV Utilities Hub</button>
    </div>

    <script type="module">
      // ---- 1) Parse Supabase tokens from URL (hash or query) ----------------
      function parseParams() {
        const raw =
          (location.hash && location.hash.slice(1)) || location.search.slice(1);
        const p = new URLSearchParams(raw);
        const access_token = p.get("access_token");
        const refresh_token = p.get("refresh_token");
        const expires_in = p.get("expires_in"); // seconds
        const token_type = p.get("token_type");
        return { access_token, refresh_token, expires_in, token_type };
      }
      const tokens = parseParams();

      // ---- 2) Tell the installed PWA/window AND any open hub tab ------------
      // Include tokens so the app can call supabase.auth.setSession(...)
      const payload = { type: "signed-in", tokens };

      // 2a) BroadcastChannel → any open hub page
      try {
        const bc = new BroadcastChannel("sasv-auth");
        bc.postMessage(payload);
      } catch {}

      // 2b) Service Worker message → wake/focus installed app (Chromium)
      if ("serviceWorker" in navigator) {
        try {
          const reg = await navigator.serviceWorker.ready;
          (reg.active || navigator.serviceWorker.controller)?.postMessage(
            payload
          );
        } catch {}
      }

      // ---- 3) Button: manual fallback to hub --------------------------------
      document.getElementById("open")?.addEventListener("click", () => {
        location.href = "/utilities-hub/";
      });

      // ---- 4) Optional: auto-navigate to hub after a short delay ------------
      setTimeout(() => {
        // If this tab shows the hub instead of the installed app, still useful
        if (!document.hidden) location.replace("/utilities-hub/");
      }, 800);
    </script>
  </body>
</html>
