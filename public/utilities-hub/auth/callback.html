<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Signing you in…</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: system-ui, Arial, sans-serif;
        margin: 24px;
        color: #0b1420;
      }
      .card {
        max-width: 560px;
        margin: 12vh auto 0;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 18px;
        background: #fff;
      }
      h1 {
        font-size: 1.25rem;
        margin: 0.2rem 0;
      }
      p {
        color: #475569;
        margin: 0.4rem 0;
      }
      button {
        margin-top: 8px;
        padding: 0.6rem 1rem;
        border-radius: 8px;
        border: 1px solid #0a62c3;
        background: #0a62c3;
        color: #fff;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Signing you in…</h1>
      <p>
        If the app is installed, it should open automatically. You can close
        this tab after it does.
      </p>
      <button id="open">Open SASV Utilities Hub</button>
    </div>

    <script type="module">
      import { supabase } from "../../shared/js/supabaseClient.js";

      // 1) Parse tokens from hash or query
      function parseParams() {
        const raw =
          (location.hash && location.hash.slice(1)) || location.search.slice(1);
        const p = new URLSearchParams(raw);
        const access_token = p.get("access_token");
        const refresh_token = p.get("refresh_token");
        const expires_in = p.get("expires_in"); // seconds
        const token_type = p.get("token_type");
        return { access_token, refresh_token, expires_in, token_type };
      }
      const tokens = parseParams();

      // Basic guard: only proceed if we actually have tokens
      const hasTokens = !!(tokens.access_token && tokens.refresh_token);

      // 2) Install session **in this tab** (works on desktop/Android, and in iOS browser)
      async function setLocalSessionIfPresent() {
        if (!hasTokens) return;
        try {
          await supabase.auth.setSession({
            access_token: tokens.access_token,
            refresh_token: tokens.refresh_token,
          });
          // Let same-origin pages know we signed in (iOS storage event fallback)
          localStorage.setItem("sasv_signed_in_at", String(Date.now()));
        } catch (e) {
          console.warn("[callback] setSession failed:", e);
        }
      }

      // 3) Tell any installed PWA / open hub tab (multi-path)
      async function notifyClients() {
        const payload = { type: "signed-in", tokens };
        // 3a) BroadcastChannel → any open hub page (desktop/Android, sometimes iOS)
        try {
          const bc = new BroadcastChannel("sasv-auth");
          bc.postMessage(payload);
        } catch {}

        // 3b) Service Worker → wake/focus installed PWA (Chromium; partial iOS)
        if ("serviceWorker" in navigator) {
          try {
            const reg = await navigator.serviceWorker.ready;
            (reg.active || navigator.serviceWorker.controller)?.postMessage(
              payload
            );
          } catch {}
        }
      }

      await setLocalSessionIfPresent();
      await notifyClients();

      // 4) Button + auto-nav fallbacks
      document.getElementById("open")?.addEventListener("click", () => {
        location.href = "/utilities-hub/";
      });
      setTimeout(() => {
        if (!document.hidden) location.replace("/utilities-hub/");
      }, 800);
    </script>
  </body>
</html>
