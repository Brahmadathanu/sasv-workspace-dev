<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SASV WORKSPACE | Material Requirements Board</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="./css/style.css" />
    <style>
      body {
        margin: 18px;
        font-family: Arial, sans-serif;
        background: var(--bg-color);
        color: var(--text-color);
        /* Use a column flex layout so main content can grow to fill viewport */
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      .header-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }
      .header-title-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        width: 100%;
      }
      @media (max-width: 640px) {
        .header-title-row {
          flex-direction: column;
          align-items: flex-start;
          gap: 6px;
        }
        .header-title-row #homeBtn {
          align-self: flex-start;
        }
      }
      .header-bar h2 {
        margin: 0;
        color: var(--primary);
      }
      .header-actions {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .section-hint {
        margin-top: 6px;
        color: var(--muted, #6b7280);
      }

      .filter-strip {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        margin: 12px 0;
      }
      .filter-pair {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      input[type="month"],
      input[type="text"],
      select {
        padding: 6px 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background: var(--input-bg);
        color: var(--input-text);
      }
      .filter-actions {
        margin-left: auto;
        display: flex;
        gap: 8px;
      }

      #rowCount {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 4px 10px;
        background: #eef6ff;
        color: #024a75;
        border-radius: 999px;
        font-weight: 600;
      }

      #mrpTableContainer {
        border: 1px solid #ccc;
        /* Ensure horizontal scroll appears on small viewports */
        overflow-x: auto;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        /* Allow the table container to expand inside .main-content flex box */
        flex: 1 1 auto;
        min-height: 0; /* allow proper flex overflow behavior */
        max-height: none;
      }

      .main-content {
        /* let main content grow to fill remaining viewport height */
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }
      #mrpTable {
        width: 100%;
        min-width: 900px; /* prevent columns from collapsing; allow container scroll */
        border-collapse: collapse;
      }
      th,
      td {
        padding: 6px 8px;
        border-bottom: 1px solid #e6eef6;
        font-size: 0.95rem;
        /* default alignment for body cells (will be overridden per-column)
           but ensure vertical centering */
        vertical-align: middle;
      }
      /* ERP-style table refinements */
      #mrpTable {
        width: 100%;
        border-collapse: collapse;
        /* Use automatic table layout so columns size to content and trigger
           horizontal scrolling instead of truncating numeric cells. */
        table-layout: auto;
      }
      th {
        background: var(--panel-bg);
        color: var(--muted);
        font-weight: 700;
        font-size: 0.86rem;
        text-transform: uppercase;
        letter-spacing: 0.02em;
        padding: 10px 12px;
        border-bottom: 2px solid rgba(0, 0, 0, 0.06);
        /* center header labels by default (overridden per-column as required) */
        text-align: center;
        vertical-align: middle;
      }
      /* Column widths and alignment */
      /* Use percentage-based columns for a balanced ERP layout */
      th[data-key="stock_item_code"],
      td:nth-child(1) {
        width: 10%;
        min-width: 90px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      th[data-key="stock_item_name"],
      td:nth-child(2) {
        /* Slightly reduced to allow more room for Flags */
        width: 38%;
        min-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      th[data-key="material_kind"],
      td:nth-child(3) {
        width: 8%;
        min-width: 70px;
        text-align: center;
      }

      th[data-key="stock_uom"],
      td:nth-child(4) {
        width: 6%;
        min-width: 60px;
        text-align: center;
      }

      th[data-key="planned_total_qty"],
      th[data-key="issued_total_qty"],
      th[data-key="net_requirement"],
      td:nth-child(5),
      td:nth-child(6),
      td:nth-child(7) {
        width: 8%;
        min-width: 80px;
        text-align: right;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono",
          monospace;
        /* Prevent numeric truncation; keep numbers on a single line so
           the table becomes horizontally scrollable instead of ellipsizing. */
        white-space: nowrap;
        overflow: visible;
      }

      td:nth-child(8) {
        /* Flags column: increase to provide room for multiple badges */
        width: 14%;
        min-width: 140px;
      }

      /* Column-specific overrides for horizontal alignment */
      /* Center small code/type/uom columns (both header and body) */
      th[data-key="stock_item_code"],
      td:nth-child(1),
      th[data-key="material_kind"],
      td:nth-child(3),
      th[data-key="stock_uom"],
      td:nth-child(4) {
        text-align: center;
      }

      /* Left align Item and Flags columns */
      th[data-key="stock_item_name"],
      td:nth-child(2),
      th:nth-child(8),
      td:nth-child(8) {
        text-align: left;
      }

      /* Right align numeric columns including headers */
      th[data-key="planned_total_qty"],
      th[data-key="issued_total_qty"],
      th[data-key="net_requirement"],
      td:nth-child(5),
      td:nth-child(6),
      td:nth-child(7) {
        text-align: right;
      }
      /* Top consumers column removed: no longer needed in table */

      td,
      th {
        vertical-align: middle;
      }

      /* Zebra striping and hover */
      tbody tr:nth-child(even) {
        background: rgba(2, 6, 23, 0.02);
      }
      tbody tr:hover {
        background: rgba(2, 6, 23, 0.04);
      }

      /* Selected row emphasis */
      tbody tr.selected {
        background: linear-gradient(
          90deg,
          rgba(3, 105, 161, 0.06),
          rgba(3, 105, 161, 0.02)
        );
      }

      /* Ensure sticky header sits above modal/tooltips */
      th {
        position: sticky;
        top: 0;
        z-index: 4;
      }
      /* Sort indicators: use inline SVG node for crisp, accessible icons */
      th.sortable {
        cursor: pointer;
      }
      th .sort-icon {
        display: inline-flex;
        align-items: center;
        margin-left: 8px;
        vertical-align: middle;
      }
      th .sort-icon svg {
        width: 14px;
        height: 14px;
        fill: none;
        stroke: currentColor;
        stroke-width: 2;
        opacity: 0.75;
      }
      th.sorted-asc .sort-icon svg {
        opacity: 1;
        transform: translateY(-1px);
      }
      th.sorted-desc .sort-icon svg {
        opacity: 1;
        transform: translateY(1px);
      }
      /* Paginator styles */
      #paginator {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      #paginator .pg-btn {
        padding: 6px 8px;
        border-radius: 6px;
        border: 1px solid rgba(0, 0, 0, 0.06);
        background: transparent;
        cursor: pointer;
      }
      #paginator .pg-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      #paginator .pg-info {
        color: var(--muted);
        font-size: 0.92rem;
      }
      #paginator select {
        padding: 6px;
        border-radius: 6px;
      }
      /* Header and row hover/selected styles consolidated above for
         deterministic styling (sticky header z-index:4, .sortable
         controls pointer cursor). */

      .flags {
        display: flex;
        gap: 6px;
        align-items: center;
        flex-wrap: nowrap; /* default: no wrap on wide screens */
      }
      .badge-warning {
        background: #fff4e5;
        color: #7a4900;
        padding: 4px 6px;
        border-radius: 999px;
        font-size: 0.8rem;
      }
      .badge-info {
        background: #e8f4ff;
        color: #045a8d;
        padding: 4px 6px;
        border-radius: 999px;
        font-size: 0.8rem;
      }

      /* Global JS-driven tooltip (replaces fragile CSS pseudo-tooltips)
           Tooltip is created and positioned by script to ensure it stays
           inside the viewport. */
      #globalTooltip {
        position: fixed;
        display: none;
        padding: 8px 12px;
        background: #2d3748;
        color: white;
        border-radius: 6px;
        font-size: 0.85rem;
        white-space: nowrap;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        pointer-events: none;
        max-width: calc(100vw - 16px);
        overflow-wrap: break-word;
      }

      /* State badge styling */
      #stateBadge {
        background: #f0f9ff;
        color: #0369a1;
        padding: 4px 12px;
        border-radius: 999px;
        font-size: 0.85rem;
        font-weight: 500;
        border: 1px solid #bae6fd;
      }

      /* Governance banner shown when monthly stats indicate planning signals */
      #mrpGovernanceBanner {
        display: none;
        margin-top: 8px;
        font-size: 0.95rem;
        border-radius: 6px;
      }

      .bar {
        height: 14px;
        background: #e6eef6;
        border-radius: 6px;
        flex: 1;
        position: relative;
        overflow: hidden;
      }
      .bar-inner {
        height: 100%;
        border-radius: 6px;
        background: linear-gradient(90deg, #69b3ff, #007bff);
        max-width: 100%;
        transition: width 240ms ease;
      }
      .bar-inner.overfull {
        background: linear-gradient(90deg, #ffb4a2, #ff6b6b);
        box-shadow: inset 0 0 0 1px rgba(255, 107, 107, 0.06);
      }
      .bar-wrap {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .top-consumers {
        margin-top: 8px;
      }

      /* Professional ERP Modal Styles */
      .modal-overlay {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        backdrop-filter: blur(4px) saturate(0.9);
        background: rgba(0, 0, 0, 0.4);
      }
      .modal-overlay[aria-hidden="false"] {
        display: flex;
      }
      .modal-dialog {
        background: var(--panel-bg);
        color: var(--text-color);
        border-radius: 12px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        width: 90vw;
        max-width: 600px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        border: 1px solid rgba(0, 0, 0, 0.1);
      }
      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px 16px;
        border-bottom: 1px solid #e6eef6;
      }
      .modal-header h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--primary);
      }
      .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--muted);
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        transition: background-color 0.2s;
      }
      .modal-close:hover {
        background: rgba(0, 0, 0, 0.05);
      }
      .modal-body {
        padding: 20px 24px;
        flex: 1;
        overflow-y: auto;
      }
      .modal-footer {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 12px;
        padding: 16px 24px 20px;
        border-top: 1px solid #e6eef6;
      }
      .progress-bar-section,
      .consumers-section {
        padding: 16px;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e6eef6;
      }
      /* Consumers table styling for modal */
      .consumers-section .consumers-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 6px;
        background: transparent;
        /* Fix layout so long consumer names don't force horizontal scroll */
        table-layout: fixed;
      }
      .consumers-section .consumers-table th,
      .consumers-section .consumers-table td {
        padding: 8px 10px;
        border-bottom: 1px solid #e6eef6;
        text-align: left;
        vertical-align: middle;
      }
      .consumers-section .consumers-table th {
        color: var(--muted);
        font-weight: 600;
        font-size: 0.92rem;
        text-transform: none;
      }
      .consumers-section .consumers-table td.qty {
        text-align: right;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono",
          monospace;
        white-space: nowrap;
      }
      /* Ensure the name column truncates nicely rather than expanding the modal */
      .consumers-section .consumers-table td:first-child,
      .consumers-section .consumers-table th:first-child {
        width: 68%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .consumers-section .consumers-table td:last-child,
      .consumers-section .consumers-table th:last-child {
        width: 32%;
      }
      .consumers-section .consumer-region {
        display: block;
        font-size: 0.85rem;
        color: var(--muted);
        margin-top: 4px;
      }
      .btn-primary,
      .btn-secondary {
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        border: 1px solid transparent;
        transition: all 0.2s;
      }
      .btn-primary {
        background: var(--primary);
        color: white;
      }
      .btn-primary:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }
      .btn-primary:hover:not(:disabled) {
        background: var(--primary-dark, #1d4ed8);
      }
      .btn-secondary {
        background: transparent;
        color: var(--text-color);
        border-color: #d1d5db;
      }
      .btn-secondary:hover {
        background: #f3f4f6;
      }

      /* Icon-style buttons used in filter-actions (compact ERP style) */
      .visually-hidden {
        position: absolute !important;
        width: 1px !important;
        height: 1px !important;
        padding: 0 !important;
        margin: -1px !important;
        overflow: hidden !important;
        clip: rect(0 0 0 0) !important;
        white-space: nowrap !important;
        border: 0 !important;
      }

      .filter-actions .link-btn {
        width: 36px;
        height: 36px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 6px;
        border-radius: 8px;
        background: transparent;
        border: 1px solid rgba(0, 0, 0, 0.04);
        color: var(--muted);
        transition: background-color 0.15s, color 0.15s, transform 0.06s;
      }

      .filter-actions .link-btn svg {
        width: 18px;
        height: 18px;
        display: block;
      }

      .filter-actions .link-btn:hover:not(:disabled) {
        background: rgba(2, 6, 23, 0.04);
        color: var(--primary);
        transform: translateY(-1px);
        border-color: rgba(0, 0, 0, 0.06);
      }

      .filter-actions .link-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Home Button */
      #homeBtn {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        border: 1px solid #fdba74 !important;
        border-radius: 6px;
        background: #fed7aa !important;
        color: #9a3412 !important;
        cursor: pointer;
        font-size: 0.875rem;
        font-family: inherit;
        font-weight: 500;
        transition: all 0.2s;
      }
      #homeBtn:hover {
        background: #fdba74 !important;
        border-color: #fb923c !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      #homeBtn svg {
        flex-shrink: 0;
      }

      @media (min-width: 900px) {
        .main-content {
          max-width: 100%;
        }
      }
      /* View (master) tabs: bold segmented control in header */
      #viewTabs {
        display: inline-flex;
        gap: 8px;
        padding: 8px;
        /* Soft blue card backing to visually separate master view from
             the surrounding UI while remaining subtle and accessible */
        background: var(--viewtabs-bg, #eef6ff);
        border-radius: 10px;
        border: 1px solid rgba(0, 0, 0, 0.06);
        box-shadow: 0 1px 4px rgba(2, 6, 23, 0.04);
      }
      #viewTabs .subtab {
        background: transparent;
        color: var(--muted);
        padding: 8px 14px;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        cursor: pointer;
      }
      #viewTabs .subtab.active,
      #viewTabs .subtab[aria-pressed="true"] {
        background: var(--primary);
        color: white;
        box-shadow: 0 6px 18px rgba(2, 6, 23, 0.06);
      }

      /* Accent colors for each master view when selected. Summary keeps
           the primary accent; Exceptions gets a warm warning-style card so
           it reads as a different category at-a-glance. */
      #viewTabs .subtab.active[data-view="summary"],
      #viewTabs .subtab[aria-pressed="true"][data-view="summary"] {
        background: var(--primary);
        color: white;
        box-shadow: 0 6px 18px rgba(2, 6, 23, 0.06);
      }

      #viewTabs .subtab.active[data-view="exceptions"],
      #viewTabs .subtab[aria-pressed="true"][data-view="exceptions"] {
        background: linear-gradient(90deg, #fff7ed, #ffedd5);
        color: #92400e;
        border: 1px solid rgba(249, 115, 22, 0.12);
        box-shadow: none;
      }

      /* Mode (refinement) tabs: lighter chip-style buttons above table */
      #boardTabs {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
      }
      #boardTabs .tab {
        border: 1px solid rgba(0, 0, 0, 0.06);
        background: rgba(255, 255, 255, 0.02);
        color: var(--text-color);
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.95rem;
      }
      #boardTabs .tab.active,
      #boardTabs .tab[aria-pressed="true"] {
        background: rgba(2, 6, 23, 0.04);
        color: var(--primary);
        border-color: rgba(0, 0, 0, 0.08);
      }
      /* small refiner dot: shown when in All mode a checkbox maps to this tab */
      #boardTabs .tab.refiner-dot {
        position: relative;
      }
      #boardTabs .tab.refiner-dot::after {
        content: "";
        position: absolute;
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: var(--primary);
        right: 6px;
        top: 6px;
        box-shadow: 0 1px 2px rgba(2, 6, 23, 0.12);
      }
      /* Loading overlay */
      #mrpLoadingOverlay {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9998;
        backdrop-filter: blur(4px) saturate(0.9);
        background: rgba(0, 0, 0, 0.28);
      }
      #mrpLoadingOverlay .panel {
        background: var(--panel-bg);
        color: var(--text-color);
        padding: 18px 22px;
        border-radius: 8px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
        display: flex;
        gap: 12px;
        align-items: center;
        min-width: 260px;
      }
      #mrpLoadingOverlay .spinner {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 4px solid rgba(0, 0, 0, 0.08);
        border-top-color: var(--primary);
        animation: mrp-spin 1s linear infinite;
      }
      @keyframes mrp-spin {
        to {
          transform: rotate(360deg);
        }
      }
      /* Drawer styles for checkbox filters */
      .drawer-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.28);
        display: none;
        z-index: 9997;
      }
      .drawer-overlay[aria-hidden="false"] {
        display: block;
      }

      .filter-drawer {
        position: fixed;
        top: 0;
        right: 0;
        width: 340px;
        height: 100vh;
        background: var(--panel-bg);
        color: var(--text-color);
        box-shadow: -16px 0 40px rgba(0, 0, 0, 0.12);
        transform: translateX(100%);
        transition: transform 240ms cubic-bezier(0.2, 0.8, 0.2, 1);
        z-index: 9998;
        display: flex;
        flex-direction: column;
        border-left: 1px solid rgba(0, 0, 0, 0.04);
      }
      .filter-drawer[aria-hidden="false"] {
        transform: translateX(0%);
      }
      .filter-drawer .drawer-header {
        padding: 16px 18px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid rgba(0, 0, 0, 0.04);
      }
      .filter-drawer .drawer-body {
        padding: 12px 16px;
        overflow: auto;
        flex: 1;
      }
      .filter-drawer .drawer-footer {
        padding: 12px 16px;
        border-top: 1px solid rgba(0, 0, 0, 0.04);
        display: flex;
        gap: 8px;
        justify-content: flex-end;
      }
      .filter-drawer .drawer-close {
        background: none;
        border: 0;
        font-size: 18px;
        cursor: pointer;
      }
      /* Responsive adjustments: let table be scrollable but reduce min-widths
         and allow badges to wrap on narrow viewports for a professional ERP feel */
      @media (max-width: 1100px) {
        #mrpTable {
          min-width: 800px;
        }
        th[data-key="stock_item_name"],
        td:nth-child(2) {
          width: 42%;
        }
        td:nth-child(8) {
          width: 12%;
        }
      }
      @media (max-width: 900px) {
        #mrpTable {
          min-width: 700px;
        }
        th[data-key="stock_item_name"],
        td:nth-child(2) {
          width: 40%;
        }
        th[data-key="stock_item_code"],
        td:nth-child(1) {
          width: 12%;
        }
        .flags {
          flex-wrap: wrap;
          gap: 4px;
        }
        th,
        td {
          padding: 6px 8px;
        }
      }
      @media (max-width: 640px) {
        #mrpTable {
          min-width: 520px;
        }
        th,
        td {
          font-size: 0.92rem;
          padding: 6px 8px;
        }
        td:nth-child(2) {
          white-space: normal;
        }
        .flags {
          flex-wrap: wrap;
          gap: 4px;
        }
      }
    </style>
  </head>
  <body data-theme="system">
    <div id="mrpLoadingOverlay" aria-hidden="true">
      <div class="panel" role="status" aria-live="polite">
        <div class="spinner" aria-hidden="true"></div>
        <div id="mrpLoadingMessage">Loading…</div>
      </div>
    </div>
    <div class="header-bar">
      <div style="flex: 1">
        <div class="header-title-row">
          <h2>MRP Material Board</h2>
          <button id="homeBtn">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
              <polyline points="9,22 9,12 15,12 15,22" />
            </svg>
            HOME
          </button>
        </div>
        <div class="section-hint">
          Review raw material & packing material requirements vs actual issues
          for planning and procurement.
        </div>
        <div style="margin-top: 8px">
          <nav
            id="viewTabs"
            aria-label="View tabs"
            style="
              display: flex;
              gap: 12px;
              align-items: center;
              margin-bottom: 12px;
            "
          >
            <div
              class="filter-pair"
              style="align-items: center; margin-right: 8px"
            >
              <label
                for="horizonMonth"
                data-tooltip="Select month to load MRP data for analysis"
                style="margin-right: 6px"
                >Month</label
              >
              <input
                id="horizonMonth"
                type="month"
                data-tooltip="Dataset month - changes reload all data"
              />
            </div>
            <button
              class="subtab active"
              data-view="summary"
              aria-pressed="true"
              data-tooltip="Show all items, refine using mode tabs and filters"
            >
              Summary
            </button>
            <button
              class="subtab"
              data-view="exceptions"
              aria-pressed="false"
              data-tooltip="Show only problematic items (unassigned/approx/no-plan/pni/over-issued)"
            >
              Exceptions
            </button>
          </nav>
          <div id="mrpGovernanceBanner" aria-live="polite"></div>
          <!-- boardTabs moved below to sit immediately above the table -->
        </div>
      </div>
    </div>

    <div id="filters" class="filter-strip">
      <div class="filter-pair">
        <label for="kindFilter" data-tooltip="Filter by material classification"
          >Material Type</label
        >
        <select
          id="kindFilter"
          data-tooltip="RM=Raw Materials, PM=Packing Materials"
        >
          <option value="ALL">All Materials</option>
          <option value="RM">RM (Raw Materials)</option>
          <option value="PM">PM (Packing Materials)</option>
        </select>
      </div>

      <div class="filter-pair" style="flex: 1 1 240px">
        <input
          id="textSearch"
          type="text"
          placeholder="Search item name, code, or ID"
          data-tooltip="Search within item names, codes, and IDs"
        />
      </div>

      <div
        id="checkboxFilters"
        style="display: none; gap: 8px; flex-wrap: wrap; align-items: center"
      >
        <div class="filter-pair">
          <label
            data-tooltip="Show only items with remaining quantity to be issued"
            ><input id="filterNetPositive" type="checkbox" /> Net requirement >
            0</label
          >
        </div>

        <div class="filter-pair">
          <label
            data-tooltip="Items with unassigned issues or approximate allocations"
            ><input id="filterAllocationIssues" type="checkbox" /> Allocation
            issues</label
          >
        </div>

        <div class="filter-pair">
          <label
            data-tooltip="Items issued to production without any plan (planned=0, issued>0)"
            ><input id="filterNoPlanButIssued" type="checkbox" /> Issued without
            plan</label
          >
        </div>

        <div class="filter-pair">
          <label
            data-tooltip="Items planned but not yet issued to production (planned>0, issued=0)"
            ><input id="filterPlannedButNotIssued" type="checkbox" /> Planned
            not issued</label
          >
        </div>

        <div class="filter-pair">
          <label
            data-tooltip="Items where issued quantity exceeds planned quantity"
            ><input id="filterOverIssued" type="checkbox" /> Over-issued</label
          >
        </div>
      </div>

      <div class="filter-actions">
        <button
          id="openFiltersDrawer"
          class="link-btn"
          data-tooltip="Open advanced filters"
        >
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            aria-hidden="true"
            focusable="false"
          >
            <path
              fill="currentColor"
              d="M3 5h18v2H3zM6 11h12v2H6zM10 17h4v2h-4z"
            />
          </svg>
          <span class="visually-hidden">Open filters</span>
        </button>
        <button
          id="clearFilters"
          class="link-btn"
          data-tooltip="Reset all filters and reload data"
        >
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            aria-hidden="true"
            focusable="false"
          >
            <path
              d="M18 6L6 18"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
            <path
              d="M6 6l12 12"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          <span class="visually-hidden">Clear filters</span>
        </button>
        <button
          id="loadDataBtn"
          class="link-btn"
          disabled
          data-tooltip="Manual data reload (currently auto-loads)"
        >
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            aria-hidden="true"
            focusable="false"
          >
            <path
              d="M21 12a9 9 0 10-3.2 6.6"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
            <path
              d="M21 3v6h-6"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          <span class="visually-hidden">Reload</span>
        </button>
        <div id="rowCount">0</div>
      </div>
    </div>

    <!-- Drawer overlay + drawer container for checkbox filters -->
    <div
      id="filterDrawerOverlay"
      class="drawer-overlay"
      aria-hidden="true"
    ></div>
    <aside id="filterDrawer" class="filter-drawer" aria-hidden="true">
      <div class="drawer-header">
        <strong>Filters</strong>
        <button class="drawer-close" aria-label="Close filters">✕</button>
      </div>
      <div class="drawer-body" id="filterDrawerBody">
        <!-- checkbox filters will be moved here by script -->
      </div>
      <div class="drawer-footer">
        <button id="drawerClear" class="btn-secondary">Clear</button>
        <button id="drawerApply" class="btn-primary">Apply</button>
        <button id="drawerClose" class="btn-secondary">Close</button>
      </div>
    </aside>

    <!-- Mode tabs: placed immediately above the table for refinement -->
    <div
      class="board-header-row"
      style="
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 12px 0;
      "
    >
      <nav
        id="boardTabs"
        aria-label="MRP modes"
        style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center"
      >
        <button
          class="tab"
          data-mode="all"
          aria-pressed="false"
          data-tooltip="Show all items for the selected month"
        >
          All
        </button>
        <button
          class="tab"
          data-mode="unassigned"
          aria-pressed="false"
          data-tooltip="Items with unassigned allocation issues"
        >
          Unassigned
        </button>
        <button
          class="tab"
          data-mode="approx"
          aria-pressed="false"
          data-tooltip="Items with approximate allocations present"
        >
          Approximate
        </button>
        <button
          class="tab"
          data-mode="shortage"
          aria-pressed="false"
          data-tooltip="Items with net requirement > 0 (remaining to be issued)"
        >
          Shortage
        </button>
        <button
          class="tab"
          data-mode="no_plan"
          aria-pressed="false"
          data-tooltip="Items issued without any production plan"
        >
          No plan
        </button>
        <button
          class="tab"
          data-mode="planned_not_issued"
          aria-pressed="false"
          data-tooltip="Items planned but not yet issued to production"
        >
          Planned not issued
        </button>
        <button
          class="tab"
          data-mode="over_issued"
          aria-pressed="false"
          data-tooltip="Items where issued quantity exceeds planned quantity"
        >
          Over issued
        </button>
      </nav>
      <div id="paginator" style="display: flex; align-items: center; gap: 8px">
        <!-- paginator UI populated by JS -->
      </div>
    </div>
    <div class="main-content">
      <div id="mrpTableContainer">
        <table id="mrpTable">
          <thead>
            <tr>
              <th data-key="stock_item_code">Code</th>
              <th data-key="stock_item_name">Item</th>
              <th data-key="material_kind">Type</th>
              <th data-key="stock_uom">UOM</th>
              <th data-key="planned_total_qty">Planned</th>
              <th data-key="issued_total_qty">Issued</th>
              <th data-key="net_requirement">Net</th>
              <th>Flags</th>
              <!-- Top consumers column removed from table; details shown in modal -->
            </tr>
          </thead>
          <tbody id="mrpTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Professional ERP Modal for item details -->
    <div id="itemDetailModal" class="modal-overlay" aria-hidden="true">
      <div
        class="modal-dialog"
        role="dialog"
        aria-modal="true"
        aria-labelledby="modalTitle"
      >
        <div class="modal-header">
          <h3 id="modalTitle">Item Details</h3>
          <button class="modal-close" aria-label="Close dialog">&times;</button>
        </div>
        <div class="modal-body">
          <div id="modalItemTitle">
            <strong>Select an item to see details</strong>
          </div>
          <div id="modalContent" style="display: none">
            <div id="modalSummary" style="margin-top: 16px"></div>
            <div class="progress-bar-section" style="margin-top: 16px">
              <div style="font-weight: 500; margin-bottom: 8px">
                Progress Overview
              </div>
              <div class="bar-wrap">
                <div style="width: 80px; font-size: 0.9rem">Planned</div>
                <div class="bar">
                  <div
                    id="modalBarInner"
                    class="bar-inner"
                    style="width: 0%"
                  ></div>
                </div>
                <div
                  style="width: 60px; text-align: right"
                  id="modalBarLabel"
                ></div>
              </div>
            </div>
            <div class="consumers-section" style="margin-top: 16px">
              <div style="font-weight: 500; margin-bottom: 8px">
                Top Consumers
              </div>
              <div id="modalTopConsumers"></div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="modalAllocationBtn" class="btn-primary" disabled>
            Open Issue Allocation Console
          </button>
        </div>
      </div>
    </div>

    <script>
      // Global tooltip manager: displays [data-tooltip] text in a single
      // fixed element and clamps it inside the viewport to avoid overflow.
      (function () {
        function onReady(fn) {
          if (document.readyState === "loading")
            document.addEventListener("DOMContentLoaded", fn);
          else fn();
        }
        onReady(function () {
          const tip = document.createElement("div");
          tip.id = "globalTooltip";
          document.body.appendChild(tip);

          function show(e) {
            const el = e.currentTarget;
            const text = el.getAttribute("data-tooltip");
            if (!text) return;
            tip.textContent = text;
            tip.style.display = "block";
            tip.style.left = "0px";
            tip.style.top = "0px";
            // allow layout to compute size
            const rect = el.getBoundingClientRect();
            const vw = Math.max(
              window.innerWidth || 0,
              document.documentElement.clientWidth
            );
            const vh = Math.max(
              window.innerHeight || 0,
              document.documentElement.clientHeight
            );
            // ensure max width fits within viewport
            tip.style.maxWidth = Math.max(80, vw - 16) + "px";
            // measure after setting content/width
            const tw = tip.offsetWidth;
            const th = tip.offsetHeight;
            let left = rect.left + rect.width / 2 - tw / 2;
            left = Math.max(8, Math.min(left, vw - tw - 8));
            // prefer above the element, fall back to below
            let top = rect.top - th - 8;
            if (top < 8) top = rect.bottom + 8;
            // clamp vertically as well
            top = Math.max(8, Math.min(top, vh - th - 8));
            tip.style.left = left + "px";
            tip.style.top = top + "px";
          }

          function hide() {
            tip.style.display = "none";
          }

          const els = document.querySelectorAll("[data-tooltip]");
          els.forEach((el) => {
            el.addEventListener("mouseenter", show);
            el.addEventListener("mouseleave", hide);
            el.addEventListener("focus", show);
            el.addEventListener("blur", hide);
          });

          // hide on scroll/resize to avoid stale positions
          window.addEventListener("scroll", hide, true);
          window.addEventListener("resize", hide);
        });
      })();
    </script>
    <script>
      // Reduce perceived latency when clicking the master view tabs by
      // applying the active state immediately on pointerdown/touchstart.
      // The canonical JS will still run on click and update the real
      // application state; this just gives instant visual feedback.
      (function () {
        function onReady(fn) {
          if (document.readyState === "loading")
            document.addEventListener("DOMContentLoaded", fn);
          else fn();
        }
        onReady(function () {
          const view = document.getElementById("viewTabs");
          if (!view) return;
          view.addEventListener(
            "pointerdown",
            function (ev) {
              const btn = ev.target.closest(".subtab");
              if (!btn) return;
              // Immediate visual activation
              Array.from(view.querySelectorAll(".subtab")).forEach((b) => {
                b.classList.remove("active");
                b.setAttribute("aria-pressed", "false");
              });
              btn.classList.add("active");
              btn.setAttribute("aria-pressed", "true");
            },
            { passive: true }
          );
        });
      })();
    </script>

    <script type="module" src="js/supabaseClient.js"></script>
    <script>
      // Drawer wiring + autofocus (run after DOM ready). This script must
      // live after the drawer and filter elements so it can move nodes.
      (function () {
        function ready(fn) {
          if (document.readyState === "loading")
            document.addEventListener("DOMContentLoaded", fn);
          else fn();
        }
        ready(function () {
          const DRAWER_DEBUG = false;
          const openBtn = document.getElementById("openFiltersDrawer");
          const overlay = document.getElementById("filterDrawerOverlay");
          const drawer = document.getElementById("filterDrawer");
          const drawerBody = document.getElementById("filterDrawerBody");

          // Move checkbox filters into the drawer body (preserve IDs/events)
          const boxWrap = document.getElementById("checkboxFilters");
          if (boxWrap && drawerBody && boxWrap.parentNode !== drawerBody) {
            drawerBody.appendChild(boxWrap);
            // Make filters visible after moving to avoid a brief flash in the
            // original position during page load.
            try {
              boxWrap.style.display = "flex";
            } catch {
              void 0;
            }
          }

          function openDrawer() {
            if (DRAWER_DEBUG)
              console.debug("openDrawer: checking checkbox states");
            [
              "filterNetPositive",
              "filterAllocationIssues",
              "filterNoPlanButIssued",
              "filterPlannedButNotIssued",
              "filterOverIssued",
            ].forEach((id) => {
              const el = document.getElementById(id);
              if (DRAWER_DEBUG)
                console.debug(
                  `openDrawer: ${id} - found: ${!!el}, checked: ${
                    el?.checked
                  }, attribute: ${el?.getAttribute("checked")}`
                );
            });

            overlay?.setAttribute("aria-hidden", "false");
            drawer?.setAttribute("aria-hidden", "false");
          }
          function closeDrawer() {
            try {
              // move focus back to the open button to avoid hiding a focused
              // element (which triggers the aria-hidden blocked warning)
              if (openBtn) openBtn.focus();
              else document.activeElement?.blur();
            } catch {
              void 0;
            }
            overlay?.setAttribute("aria-hidden", "true");
            drawer?.setAttribute("aria-hidden", "true");
          }

          openBtn?.addEventListener("click", openDrawer);
          overlay?.addEventListener("click", closeDrawer);
          drawer
            ?.querySelectorAll(".drawer-close, #drawerClose")
            .forEach((b) => b.addEventListener("click", closeDrawer));
          window.addEventListener("keydown", (e) => {
            if (e.key === "Escape") closeDrawer();
          });

          const applyBtn = document.getElementById("drawerApply");
          const clearBtn = document.getElementById("drawerClear");
          if (applyBtn)
            applyBtn.addEventListener("click", () => {
              // Close drawer then dispatch a namespaced event to commit
              // staged filters. The main module listens for `drawer:apply`.
              closeDrawer();
              try {
                document.dispatchEvent(new CustomEvent("drawer:apply"));
              } catch (e) {
                // fallback: no-op
                void 0;
              }
            });

          if (clearBtn)
            clearBtn.addEventListener("click", () => {
              // Do not close drawer - let user continue editing.
              // Clear checkbox inputs inside the drawer and dispatch a
              // single `drawer:cleared` event for the main module to handle.
              const inputs = drawerBody.querySelectorAll(
                'input[type="checkbox"]'
              );
              inputs.forEach((i) => {
                i.checked = false;
                try {
                  i.removeAttribute("checked");
                } catch {
                  void 0;
                }
              });
              try {
                document.dispatchEvent(new CustomEvent("drawer:cleared"));
              } catch (e) {
                // fallback noop
                void 0;
              }
            });

          // autofocus search field on load
          const search = document.getElementById("textSearch");
          if (search) {
            // delay slightly so browser UI settles
            setTimeout(() => {
              try {
                search.focus();
                search.select();
              } catch (e) {}
            }, 120);
          }
        });
      })();
    </script>
    <script type="module" src="js/mrp-material-board.js"></script>
  </body>
</html>
