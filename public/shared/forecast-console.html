<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Forecast Console</title>
    <link rel="stylesheet" href="css/style.css" />
    <style>
      :root {
        --muted: #6b7280;
        --panel-bg: var(--panel-bg, #ffffff);
        --surface-shadow: rgba(15, 23, 42, 0.06);
      }

      html,
      body {
        width: 100%;
        height: 100%;
      }
      body {
        font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
        color: var(--text-color, #111827);
        margin: 0; /* remove external gutters so module can use full viewport */
        padding: 0;
      }

      .fc-wrap {
        /* Provide safe side gutters so elements don't overflow the viewport.
           Use full available width but subtract a fixed gutter so horizontal
           scrollbars caused by platform scrollbars or rounding won't appear. */
        width: 100%;
        max-width: calc(100vw - 32px);
        margin: 0 auto;
        padding: 0 16px 24px;
        box-sizing: border-box;
        /* Make the main wrapper a column flex container so the central
           grid area can flex and allow internal scrolling without causing
           the page to overflow. This prevents using both page scrollbar
           and internal table scrollbar simultaneously. */
        display: flex;
        flex-direction: column;
        height: 100vh;
        min-height: 0;
      }

      /* Ensure each tab panel uses a column layout and that its grid area
         can shrink (min-height:0) so the internal .table-scroll-wrap can
         manage its own scrolling without growing the page. */
      .tab-panel {
        display: flex;
        flex-direction: column;
        min-height: 0;
        flex: 1 1 auto; /* allow active panel to take remaining space */
      }

      .tab-panel .grid {
        /* grid should take remaining vertical space inside the tab-panel */
        flex: 1 1 auto;
        min-height: 0; /* allow children to set overflow */
        overflow: hidden; /* prevent grid from adding page scroll */
        display: flex;
        flex-direction: column;
      }

      /* table-scroll-wrap will scroll internally */
      .table-scroll-wrap {
        flex: 1 1 auto;
        min-height: 0;
        overflow-y: auto;
      }

      /* Ensure grids/tables can scroll internally on small viewports rather
         than forcing the entire page to overflow horizontally. */
      .grid {
        overflow-x: auto; /* prefer horizontal scroll inside the grid */
      }
      .grid table {
        max-width: none; /* allow table to be wider than container and let .grid scroll */
        width: 100%;
      }

      .page-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 8px 0 12px;
        gap: 12px;
      }

      /* allow header to wrap on narrow viewports so buttons don't force overflow */
      .page-header {
        flex-wrap: wrap;
      }
      .page-header h1 {
        flex: 1 1 auto;
        min-width: 0; /* allow truncation if needed */
      }
      .header-actions {
        flex: 0 0 auto;
      }

      .page-header h1 {
        margin: 0;
        font-size: 2rem;
        color: var(--primary, #3b82f6);
      }

      .page-lead {
        margin: 0 0 20px;
        color: var(--muted);
        font-size: 0.9rem;
        max-width: 720px;
      }

      .header-actions {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      #homeBtn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        border: 1px solid #fdba74 !important;
        border-radius: 6px;
        background: #fed7aa !important;
        color: #9a3412 !important;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s ease;
      }

      #homeBtn svg {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
      }

      #homeBtn:hover {
        background: #fdba74 !important;
        border-color: #fb923c !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
      }

      .tabs-wrap {
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
        margin: 0 0 18px;
      }

      .tabs {
        display: flex;
        gap: 8px;
        padding: 0 16px;
        background: var(--panel-bg, #fff);
        border: 1px solid rgba(15, 23, 42, 0.08);
        border-radius: 12px;
        box-shadow: 0 10px 24px var(--surface-shadow);
        overflow-x: auto;
        flex: 1 1 auto;
        white-space: nowrap;
        scroll-snap-type: x proximity;
      }

      .tabs::-webkit-scrollbar {
        height: 8px;
      }

      .tabs::-webkit-scrollbar-thumb {
        background: rgba(15, 23, 42, 0.12);
        border-radius: 6px;
      }

      .tabs-chevron {
        width: 34px;
        height: 34px;
        border-radius: 999px;
        border: 1px solid rgba(15, 23, 42, 0.12);
        background: var(--panel-bg, #fff);
        color: var(--muted);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s ease, color 0.2s ease;
      }

      .tabs-chevron svg {
        width: 16px;
        height: 16px;
      }

      .tabs-chevron:hover:not([disabled]) {
        background: #f1f5f9;
        color: #1e3a8a;
      }

      .tabs-chevron[disabled] {
        opacity: 0.35;
        cursor: default;
      }

      .tab-btn {
        display: inline-flex;
        align-items: center;
        gap: 12px;
        padding: 12px 14px;
        border-radius: 10px;
        border: 1px solid transparent;
        background: transparent;
        color: #1f2937;
        font-size: 0.88rem;
        font-weight: 600;
        transition: all 0.2s ease;
        scroll-snap-align: start;
        min-height: 54px;
        text-align: left;
      }

      .tab-btn svg {
        width: 18px;
        height: 18px;
        color: #64748b;
        flex-shrink: 0;
        transition: color 0.2s ease;
      }

      .tab-btn > div {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .tab-description {
        font-size: 0.72rem;
        color: #94a3b8;
        font-weight: 400;
      }

      .tab-btn:hover {
        background: rgba(37, 99, 235, 0.08);
        border-color: rgba(37, 99, 235, 0.16);
        color: #1d4ed8;
      }

      .tab-btn:hover svg {
        color: #2563eb;
      }

      .tab-btn[aria-selected="true"],
      .tab-btn.active {
        background: linear-gradient(
          180deg,
          rgba(37, 99, 235, 0.18),
          rgba(37, 99, 235, 0.08)
        );
        border-color: rgba(37, 99, 235, 0.32);
        color: #1e3a8a;
        box-shadow: 0 8px 20px rgba(37, 99, 235, 0.18);
      }

      .tab-btn[aria-selected="true"] svg,
      .tab-btn.active svg {
        color: #1d4ed8;
      }

      @media (max-width: 720px) {
        .tab-btn {
          gap: 8px;
          padding: 10px 12px;
          min-height: 48px;
        }

        .tab-description {
          display: none;
        }
      }

      .tab-panel {
        display: none;
      }

      .tab-panel.active {
        display: flex;
      }

      .tab-panel[hidden] {
        display: none !important;
      }

      .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: flex-end;
        margin-bottom: 12px;
      }

      /* Layout for the toolbar: ensure the toolbar wraps and FILTERS takes
         a full new row. Force ordering so Load stays on the first line and
         FILTERS occupies the next line. */
      .enhanced-toolbar.single-line {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: flex-end;
      }

      /* Place the Load actions earlier in order so they remain on the first line. */
      .enhanced-toolbar.single-line .filter-actions {
        order: 10;
      }

      /* Make FILTERS occupy a full-width row below the main controls. */
      .enhanced-toolbar.single-line .filter-group.filter-row {
        order: 99;
        flex-basis: 100% !important;
        width: 100% !important;
        display: flex;
        align-items: center;
        gap: 12px;
        padding-top: 6px;
        /* Ensure filter row behaves as a block-level row where the label
           sits on the left and the checkbox container takes the remaining
           width. This allows checkboxes to start under the DATASET control. */
        justify-content: flex-start;
      }

      .enhanced-toolbar.single-line .filter-group.filter-row > .filter-label {
        /* Increase label width so the checkbox group begins under inputs
           (not under the label text). Tweak this value if your labels or
           inputs use different widths on your platform. */
        min-width: 140px;
        margin-bottom: 0;
      }

      .enhanced-toolbar.single-line .filter-checkboxes {
        display: flex;
        gap: 18px;
        align-items: center;
        flex-wrap: wrap;
        flex: 1 1 auto; /* allow the checkbox row to take remaining space */
        /* Distribute the checkboxes across remaining width */
        justify-content: space-between;
      }

      /* Row for outputs filters placed below the toolbar; left-align the
         checkbox group so filters start at the content edge. */
      .outputs-filters-row {
        display: flex;
        align-items: center;
        gap: 18px;
        padding-left: 0; /* left align */
        margin-bottom: 12px;
      }

      /* Ensure checkboxes in the outputs filters are left-aligned and
         grouped closely. */
      .outputs-filters-row .filter-checkboxes {
        justify-content: flex-start !important;
        gap: 12px;
      }
      .outputs-filters-row #btnResetOutputs {
        margin-left: auto; /* push the Reset button to the far right of the row */
      }
      .outputs-filters-row #btnResetExceptions {
        margin-left: auto; /* push the Exceptions Reset button to the far right */
      }

      .tile {
        border: 1px solid rgba(15, 23, 42, 0.08);
        border-radius: 10px;
        padding: 14px 16px;
        min-width: 180px;
        background: var(--panel-bg, #fff);
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
      }

      .tile h4 {
        margin: 0 0 6px;
        font-size: 0.8rem;
        color: #475569;
        letter-spacing: 0.01em;
        text-transform: uppercase;
      }

      .tile .big {
        font-size: 1.45rem;
        font-weight: 700;
      }

      .muted {
        color: var(--muted, #6b7280);
      }

      .warn {
        color: #b45309;
      }

      .ok {
        color: #047857;
      }

      .grid {
        overflow: auto;
        border: 1px solid rgba(15, 23, 42, 0.1);
        border-radius: 12px;
        background: var(--panel-bg, #fff);
        box-shadow: 0 8px 16px rgba(15, 23, 42, 0.05);
      }

      .grid table {
        width: 100%;
        border-collapse: collapse;
        min-width: 720px;
      }

      /* On narrow viewports allow the table to shrink and rely on internal
         horizontal scrolling rather than forcing the entire page to overflow. */
      @media (max-width: 760px) {
        .grid table {
          min-width: 0;
        }
        .fc-wrap {
          padding: 0 12px 20px;
        }
        .page-header h1 {
          font-size: 1.25rem; /* slightly smaller on very narrow screens */
        }
      }

      .grid thead th {
        background: #f8fafc;
        color: #1f2937;
        font-size: 0.75rem;
        font-weight: 600;
        letter-spacing: 0.02em;
        text-transform: uppercase;
        padding: 10px 14px;
        border-bottom: 1px solid rgba(15, 23, 42, 0.1);
      }

      /* Ensure the ITEM column header and cells are left-aligned while
         keeping other headers centered by default. The JS rendering adds
         the `col-item` class to ITEM cells/headers. */
      #outputsTable thead th.col-item,
      #outputsTable tbody td.col-item {
        text-align: left;
      }

      .grid tbody td {
        padding: 10px 14px;
        font-size: 0.85rem;
        border-bottom: 1px solid rgba(15, 23, 42, 0.06);
        color: #111827;
      }

      .grid tbody tr:nth-child(even) {
        background: rgba(148, 163, 184, 0.08);
      }

      .grid tbody tr:hover {
        background: rgba(37, 99, 235, 0.08);
      }

      .section-title {
        margin: 18px 0 12px;
        font-size: 1rem;
        font-weight: 600;
        color: #1f2937;
      }

      #fcModal::backdrop {
        background: rgba(15, 23, 42, 0.45);
      }

      #fcModal {
        border: none;
        border-radius: 10px;
        padding: 0;
      }
    </style>
  </head>
  <body data-theme="system">
    <div class="fc-wrap">
      <header class="page-header">
        <div>
          <h1>Forecast Console</h1>
        </div>
        <div class="header-actions">
          <button id="homeBtn" type="button" title="Home">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              aria-hidden="true"
              focusable="false"
            >
              <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
              <polyline points="9,22 9,12 15,12 15,22" />
            </svg>
            HOME
          </button>
        </div>
      </header>
      <!-- Tabs -->
      <div class="tabs-wrap">
        <button
          class="tabs-chevron left"
          type="button"
          aria-label="Scroll sections left"
        >
          <svg
            width="14"
            height="14"
            viewBox="0 0 24 24"
            fill="none"
            aria-hidden="true"
            focusable="false"
          >
            <path
              d="M15 18l-6-6 6-6"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </button>
        <nav class="tabs" role="tablist" aria-label="Forecast Console Sections">
          <button
            class="tab-btn active"
            id="tab-btn-overview"
            type="button"
            role="tab"
            aria-controls="tab-overview"
            aria-selected="true"
            data-tab="overview"
            tabindex="0"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              aria-hidden="true"
              focusable="false"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M3 12h4v8H3z" />
              <path d="M10 6h4v14h-4z" />
              <path d="M17 3h4v17h-4z" />
            </svg>
            <div>
              Overview
              <span class="tab-description">Health & tracking</span>
            </div>
          </button>

          <button
            class="tab-btn"
            id="tab-btn-overrides"
            type="button"
            role="tab"
            aria-controls="tab-overrides"
            aria-selected="false"
            data-tab="overrides"
            tabindex="-1"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              aria-hidden="true"
              focusable="false"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M3 17v4h4l10-10-4-4L3 17z" />
              <path d="M14 7l4 4" />
            </svg>
            <div>
              Overrides
              <span class="tab-description">Marketing inputs & revisions</span>
            </div>
          </button>

          <button
            class="tab-btn"
            id="tab-btn-outputs"
            type="button"
            role="tab"
            aria-controls="tab-outputs"
            aria-selected="false"
            data-tab="outputs"
            tabindex="-1"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              aria-hidden="true"
              focusable="false"
              stroke="currentColor"
              stroke-width="2"
            >
              <rect x="3" y="4" width="18" height="16" rx="2" />
              <line x1="3" y1="10" x2="21" y2="10" />
              <line x1="9" y1="4" x2="9" y2="20" />
            </svg>
            <div>
              Model Outputs
              <span class="tab-description">Baseline and LLT views</span>
            </div>
          </button>

          <button
            class="tab-btn"
            id="tab-btn-exceptions"
            type="button"
            role="tab"
            aria-controls="tab-exceptions"
            aria-selected="false"
            data-tab="exceptions"
            tabindex="-1"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              aria-hidden="true"
              focusable="false"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
              />
              <path d="M12 9v5" />
              <path d="M12 17h.01" />
            </svg>
            <div>
              Exceptions
              <span class="tab-description">Gaps & outliers to review</span>
            </div>
          </button>

          <button
            class="tab-btn"
            id="tab-btn-publish"
            type="button"
            role="tab"
            aria-controls="tab-publish"
            aria-selected="false"
            data-tab="publish"
            tabindex="-1"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              aria-hidden="true"
              focusable="false"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="7,10 12,5 17,10" />
              <line x1="12" y1="5" x2="12" y2="21" />
            </svg>
            <div>
              Publish
              <span class="tab-description">Snapshot and share plans</span>
            </div>
          </button>
        </nav>
        <button
          class="tabs-chevron right"
          type="button"
          aria-label="Scroll sections right"
        >
          <svg
            width="14"
            height="14"
            viewBox="0 0 24 24"
            fill="none"
            aria-hidden="true"
            focusable="false"
          >
            <path
              d="M9 6l6 6-6 6"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </button>
      </div>
      <!-- Filters removed: From/To/SKU/Region/Godown/Reset (handled via defaults) -->

      <!-- OVERVIEW -->
      <section
        class="tab-panel active"
        id="tab-overview"
        role="tabpanel"
        aria-labelledby="tab-btn-overview"
      >
        <h3 class="section-title">Health Summary</h3>
        <div class="row" id="overviewTiles">
          <div class="tile">
            <h4>Window</h4>
            <div class="big" id="tileWindow">--</div>
          </div>
          <div class="tile">
            <h4>Pairs (Combined)</h4>
            <div class="big" id="tilePairs">--</div>
          </div>
          <div class="tile">
            <h4>Rows (Combined)</h4>
            <div class="big" id="tileRows">--</div>
          </div>
          <div class="tile">
            <h4>Missing LLT</h4>
            <div class="big warn" id="tileMissLLT">--</div>
          </div>
          <div class="tile">
            <h4>Missing Seasonal</h4>
            <div class="big warn" id="tileMissSeason">--</div>
          </div>
          <div class="tile">
            <h4>Active Overrides</h4>
            <div class="big ok" id="tileOverrides">--</div>
          </div>
        </div>

        <h3 class="section-title">Latest Runs</h3>
        <div class="grid">
          <div class="table-scroll-wrap">
            <table id="runsTable">
              <thead>
                <tr>
                  <th>Run ID</th>
                  <th>Module</th>
                  <th>As Of</th>
                  <th>Horizon</th>
                  <th>Status</th>
                  <th>Created</th>
                  <th>Closed</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- MODEL OUTPUTS -->
      <section
        class="tab-panel"
        id="tab-outputs"
        role="tabpanel"
        aria-labelledby="tab-btn-outputs"
        hidden
      >
        <div class="enhanced-toolbar single-line">
          <div class="filter-group">
            <label class="filter-label">DATASET</label>
            <select id="outputsDataset" class="filter-input">
              <option value="baseline">Baseline (effective)</option>
              <option value="llt">LLT</option>
              <option value="seasonal">Seasonal</option>
              <option value="combined">Combined Plan</option>
            </select>
          </div>

          <div class="filter-group">
            <label class="filter-label" for="outputsFrom">FROM</label>
            <input id="outputsFrom" class="filter-input" type="month" />
          </div>

          <div class="filter-group">
            <label class="filter-label" for="outputsTo">TO</label>
            <input id="outputsTo" class="filter-input" type="month" />
          </div>

          <div class="filter-group">
            <label class="filter-label" for="outputsSku">SKU ID</label>
            <input id="outputsSku" class="filter-input" type="number" />
          </div>

          <div class="filter-group">
            <label class="filter-label" for="outputsItem">ITEM</label>
            <input id="outputsItem" class="filter-input" type="text" />
          </div>

          <div class="filter-group">
            <label class="filter-label" for="outputsRegion">REGION</label>
            <input
              id="outputsRegion"
              class="filter-input"
              type="text"
              placeholder="region code"
            />
          </div>

          <div class="filter-group">
            <label class="filter-label" for="outputsGodown">GODOWN</label>
            <input
              id="outputsGodown"
              class="filter-input"
              type="text"
              placeholder="godown code"
            />
          </div>

          <!-- FILTERS moved below Load button (see further down) -->

          <div class="filter-group filter-actions">
            <button class="btn primary" id="btnLoadOutputs">Load</button>
          </div>

          <!-- FILTERS moved out of the toolbar and will be rendered below -->
        </div>

        <!-- FILTERS: placed on a separate row under the toolbar so checkboxes
             start aligned under the dataset control. -->
        <div class="outputs-filters-row">
          <div class="filter-checkboxes">
            <label style="font-weight: 400"
              ><input type="checkbox" id="outputsFilterOverride" /> OVERRIDE
              Î”</label
            >
            <label style="font-weight: 400"
              ><input type="checkbox" id="outputsFilterSupplyLlt" /> SUPPLY
              LLT</label
            >
            <label style="font-weight: 400"
              ><input type="checkbox" id="outputsFilterSupplySeasonal" /> SUPPLY
              SEASONAL</label
            >
          </div>
          <button
            id="btnResetOutputs"
            class="btn ghost"
            type="button"
            title="Reset Filters"
            aria-label="Reset Filters"
          >
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" />
              <path d="M21 3v5h-5" />
              <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" />
              <path d="M3 21v-5h5" />
            </svg>
          </button>
        </div>

        <!-- Pagination & actions: moved to top-right to match Production Planning Workbench -->
        <div class="pagination">
          <button id="btnExportOutputs" class="action-btn secondary">
            Export CSV
          </button>
          <div class="pagination-controls">
            <label
              class="small muted"
              for="outputsPageSize"
              style="
                display: flex;
                align-items: center;
                gap: 6px;
                margin-right: 4px;
              "
              >Page Size
              <select
                id="outputsPageSize"
                class="small"
                style="
                  margin-left: 6px;
                  padding: 4px 6px;
                  border-radius: 4px;
                  border: 1px solid #d1d5db;
                  background: #fff;
                "
              >
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </label>
            <button class="btn" id="prevPageOutputs">Previous</button>
            <span class="small muted" id="pageInfoOutputs">Page 1</span>
            <button class="btn" id="nextPageOutputs">Next</button>
          </div>
        </div>
        <div class="grid">
          <div class="table-scroll-wrap">
            <table id="outputsTable">
              <thead>
                <tr id="outputsHeader"></tr>
              </thead>
              <tbody id="outputsBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- EXCEPTIONS (stub for next step) -->
      <section
        class="tab-panel"
        id="tab-exceptions"
        role="tabpanel"
        aria-labelledby="tab-btn-exceptions"
        hidden
      >
        <!-- Filters for Exceptions -->
        <div class="enhanced-toolbar single-line">
          <div class="filter-group">
            <label class="filter-label" for="exceptionsSku">SKU ID</label>
            <input id="exceptionsSku" class="filter-input" type="number" />
          </div>
          <div class="filter-group">
            <label class="filter-label" for="exceptionsItem">ITEM</label>
            <input id="exceptionsItem" class="filter-input" type="text" />
          </div>
          <div class="filter-group">
            <label class="filter-label" for="exceptionsRegion">REGION</label>
            <input
              id="exceptionsRegion"
              class="filter-input"
              type="text"
              placeholder="region code or id"
            />
          </div>
          <div class="filter-group">
            <label class="filter-label" for="exceptionsGodown">GODOWN</label>
            <input
              id="exceptionsGodown"
              class="filter-input"
              type="text"
              placeholder="godown code or id"
            />
          </div>
        </div>

        <div class="outputs-filters-row">
          <div class="filter-checkboxes">
            <label style="font-weight: 400"
              ><input type="checkbox" id="exceptionsFilterSupplyLlt" /> SUPPLY
              LLT</label
            >
            <label style="font-weight: 400"
              ><input type="checkbox" id="exceptionsFilterSupplySeasonal" />
              SUPPLY SEASONAL</label
            >
          </div>
          <button
            id="btnResetExceptions"
            class="btn ghost"
            type="button"
            title="Reset Filters"
            aria-label="Reset Exceptions Filters"
          >
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" />
              <path d="M21 3v5h-5" />
              <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" />
              <path d="M3 21v-5h5" />
            </svg>
          </button>
        </div>

        <div class="pagination">
          <button id="btnExportExceptions" class="action-btn secondary">
            Export CSV
          </button>
          <div class="pagination-controls">
            <label
              class="small muted"
              for="exceptionsPageSize"
              style="
                display: flex;
                align-items: center;
                gap: 6px;
                margin-right: 4px;
              "
              >Page Size
              <select
                id="exceptionsPageSize"
                class="small"
                style="
                  margin-left: 6px;
                  padding: 4px 6px;
                  border-radius: 4px;
                  border: 1px solid #d1d5db;
                  background: #fff;
                "
              >
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </label>
            <button class="btn" id="prevPageExceptions">Previous</button>
            <span class="small muted" id="pageInfoExceptions">Page 1</span>
            <button class="btn" id="nextPageExceptions">Next</button>
          </div>
        </div>
        <div class="grid">
          <div class="table-scroll-wrap">
            <table id="exceptionsTable">
              <thead>
                <tr>
                  <th class="col-center">SKU ID</th>
                  <th class="col-item">Item</th>
                  <th class="col-center">Pack Size</th>
                  <th class="col-center">UOM</th>
                  <th class="col-center">Region Code</th>
                  <th class="col-center">Godown Code</th>
                  <th class="col-center">Month</th>
                  <th class="col-center">Demand (effective)</th>
                  <th class="col-center">Supply LLT</th>
                  <th class="col-center">Supply Seasonal</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- OVERRIDES -->
      <section
        class="tab-panel"
        id="tab-overrides"
        role="tabpanel"
        aria-labelledby="tab-btn-overrides"
        hidden
      >
        <!-- Run Controls (moved here, only visible in Overrides tab) -->
        <section class="panel" id="runControls">
          <h3>Run Controls</h3>
          <div
            style="
              display: flex;
              gap: 16px;
              flex-wrap: wrap;
              align-items: flex-end;
            "
          >
            <!-- Primary: Apply overrides then LLT+Seasonal -->
            <div>
              <label for="monthsWindow"><small>Months window</small></label
              ><br />
              <input
                id="monthsWindow"
                type="number"
                min="1"
                max="12"
                value="3"
                style="width: 80px"
              />
            </div>
            <div>
              <label for="asOfDate"><small>As-of date (optional)</small></label
              ><br />
              <input id="asOfDate" type="date" />
            </div>
            <div>
              <label for="dryRun"><small>Dry-run</small></label
              ><br />
              <input id="dryRun" type="checkbox" />
            </div>
            <button id="btnApplyOverridesAndDerived" class="btn primary">
              Apply Marketing Overrides -> Re-run LLT & Seasonal
            </button>
            <button id="btnFullRebuild" class="btn danger">
              Full Rebuild: Baseline + LLT + Seasonal
            </button>
          </div>
          <div id="runNotes" class="section-hint" style="margin-top: 8px">
            Tip: Primary button does <b>not</b> re-stat baseline. Full rebuild
            regenerates baseline first.
          </div>
          <div id="runStatus" style="margin-top: 12px">
            <!-- status chips appear here -->
          </div>
        </section>
        <!-- Marketing Overrides removed per request -->

        <!-- Toast -->
        <div
          id="toast"
          style="
            position: fixed;
            right: 16px;
            bottom: 16px;
            background: #111;
            color: #fff;
            padding: 10px 14px;
            border-radius: 8px;
            display: none;
            z-index: 9999;
          "
        ></div>

        <!-- Overrides interactive controls removed per request -->
        <!-- Window selection -->
        <div class="card overrides-window-card">
          <div class="overrides-window-header">
            <h3>Overrides Window</h3>
            <p class="muted small">
              Choose the month range to scope both staging and promoted
              overrides.
            </p>
          </div>
          <div class="overrides-window-controls">
            <div class="overrides-window-range">
              <label for="fromMonth" class="small muted">From</label>
              <input
                id="fromMonth"
                type="month"
                title="From month"
                class="toolbar-compact"
              />
              <label for="toMonth" class="small muted">To</label>
              <input
                id="toMonth"
                type="month"
                title="To month"
                class="toolbar-compact"
              />
              <!-- keep original filterMonth id as hidden (backwards compatibility for JS) -->
              <input id="filterMonth" type="hidden" />
            </div>
            <div class="overrides-window-actions">
              <div class="baseline-download-trigger">
                <button
                  id="btnDownloadTemplate"
                  class="btn"
                  title="Download Baseline Forecasts"
                >
                  Download Baseline Forecast
                </button>
                <div id="baselineDownloads" class="baseline-download-menu">
                  <div class="baseline-download-menu-list">
                    <button id="downloadBaseline1" class="btn">
                      HO:IK Baseline
                    </button>
                    <button id="downloadBaseline3" class="btn">
                      KKD Baseline
                    </button>
                    <button id="downloadBaseline2" class="btn">
                      HO:OK Baseline
                    </button>
                  </div>
                </div>
              </div>
              <input id="csvFile" type="file" accept=".csv" hidden />
              <button
                id="btnImportCsv"
                class="btn"
                title="Import overrides into staging table"
              >
                Import Overrides (CSV)
              </button>
            </div>
          </div>
        </div>
        <!-- Staging & Overrides (copied from demand-overrides) -->
        <div class="grid-2">
          <div class="card">
            <div
              style="
                display: flex;
                align-items: center;
                gap: 12px;
                justify-content: space-between;
                margin-bottom: 10px;
              "
            >
              <h3 style="margin: 0">
                Overrides Staging
                <span class="muted" style="font-size: 0.85rem; font-weight: 400"
                  >(marketing_overrides_staging)</span
                >
              </h3>
              <span
                id="stagingCounts"
                class="status muted"
                style="margin-left: 16px"
              ></span>
            </div>
            <div class="toolbar staging-toolbar">
              <div class="staging-filters enhanced-toolbar">
                <div class="filters-row">
                  <div class="filter-group">
                    <label class="filter-label" for="filterProduct"
                      >Product</label
                    >
                    <select
                      id="filterProduct"
                      class="filter-input"
                      title="Product"
                    >
                      <option value="">All Products</option>
                    </select>
                  </div>
                  <div class="filter-group">
                    <label class="filter-label" for="filterRegion"
                      >Region</label
                    >
                    <select
                      id="filterRegion"
                      class="filter-input"
                      title="Region"
                    >
                      <option value="">All Regions</option>
                    </select>
                  </div>
                  <div class="filter-group">
                    <label class="filter-label" for="filterGodown"
                      >Godown</label
                    >
                    <select
                      id="filterGodown"
                      class="filter-input"
                      title="Godown"
                    >
                      <option value="">All Godowns</option>
                    </select>
                  </div>
                  <div class="filter-group delta-group">
                    <label class="filter-label" for="filterDeltaOp"
                      >Delta</label
                    >
                    <div class="delta-range">
                      <select
                        id="filterDeltaOp"
                        class="filter-input delta-operator"
                        title="Delta operator"
                      >
                        <option value="">All Delta</option>
                        <option value="lt">Delta &lt; threshold</option>
                        <option value="gt">Delta &gt; threshold</option>
                        <option value="between">Delta between</option>
                      </select>
                      <input
                        id="filterDeltaVal1"
                        class="filter-input delta-input"
                        type="number"
                        placeholder="threshold"
                      />
                      <input
                        id="filterDeltaVal2"
                        class="filter-input delta-input"
                        type="number"
                        placeholder="to"
                        style="display: none"
                      />
                    </div>
                  </div>
                  <button
                    id="btnResetStagingFilters"
                    class="btn ghost"
                    type="button"
                    title="Reset Filters"
                    aria-label="Reset Staging Filters"
                  >
                    <svg
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path
                        d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"
                      />
                      <path d="M21 3v5h-5" />
                      <path
                        d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"
                      />
                      <path d="M3 21v-5h5" />
                    </svg>
                  </button>
                </div>
              </div>
              <div class="staging-row">
                <div class="staging-actions">
                  <button id="btnAddRow" class="btn">Add Row</button>
                  <button
                    id="btnPromoteAll"
                    class="btn primary"
                    title="Promote all staged overrides in window"
                  >
                    Promote All
                  </button>
                  <button id="btnClearStaging" class="btn danger">
                    Delete All
                  </button>
                </div>
                <div class="pager-compact pager-right staging-pager">
                  <label class="small muted pager-size" for="stagingPageSize">
                    Page Size
                    <select id="stagingPageSize" aria-label="Staging page size">
                      <option value="20">20</option>
                      <option value="50" selected>50</option>
                      <option value="100">100</option>
                    </select>
                  </label>
                  <button
                    id="stagingPrev"
                    class="btn"
                    aria-label="Previous page"
                  >
                    Previous
                  </button>
                  <span id="stagingPager" class="muted small">Page 1 / 1</span>
                  <button id="stagingNext" class="btn" aria-label="Next page">
                    Next
                  </button>
                </div>
              </div>
            </div>
            <div class="table-scroll-wrap overrides-table-wrap">
              <table id="tblStaging">
                <thead>
                  <tr>
                    <th class="nowrap">ID</th>
                    <th class="col-item">Product</th>
                    <th>Pack Size</th>
                    <th>UOM</th>
                    <th>Region</th>
                    <th>Godown</th>
                    <th>Month</th>
                    <th class="right">Delta Units</th>
                    <th class="col-note">Note</th>
                    <th class="col-actions center">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- filled by JS -->
                </tbody>
              </table>
            </div>
          </div>

          <div class="card">
            <div
              style="
                display: flex;
                align-items: center;
                gap: 12px;
                justify-content: space-between;
                margin-bottom: 10px;
              "
            >
              <h3 style="margin: 0">
                Promoted Overrides
                <span class="muted" style="font-size: 0.85rem; font-weight: 400"
                  >(forecast_demand_overrides)</span
                >
              </h3>
              <span
                id="activeCounts"
                class="status muted"
                style="margin-left: 16px"
              ></span>
            </div>
            <div class="toolbar active-toolbar">
              <div class="active-filters enhanced-toolbar">
                <div class="filters-row">
                  <div class="filter-group">
                    <label class="filter-label" for="activeFilterProduct"
                      >Product</label
                    >
                    <select
                      id="activeFilterProduct"
                      class="filter-input"
                      title="Product"
                    >
                      <option value="">All Products</option>
                    </select>
                  </div>
                  <div class="filter-group">
                    <label class="filter-label" for="activeFilterRegion"
                      >Region</label
                    >
                    <select
                      id="activeFilterRegion"
                      class="filter-input"
                      title="Region"
                    >
                      <option value="">All Regions</option>
                    </select>
                  </div>
                  <div class="filter-group">
                    <label class="filter-label" for="activeFilterGodown"
                      >Godown</label
                    >
                    <select
                      id="activeFilterGodown"
                      class="filter-input"
                      title="Godown"
                    >
                      <option value="">All Godowns</option>
                    </select>
                  </div>
                  <div class="filter-group delta-group">
                    <label class="filter-label" for="activeFilterDeltaOp"
                      >Delta</label
                    >
                    <div class="delta-range">
                      <select
                        id="activeFilterDeltaOp"
                        class="filter-input delta-operator"
                        title="Delta operator"
                      >
                        <option value="">All Delta</option>
                        <option value="lt">Delta &lt; threshold</option>
                        <option value="gt">Delta &gt; threshold</option>
                        <option value="between">Delta between</option>
                      </select>
                      <input
                        id="activeFilterDeltaVal1"
                        class="filter-input delta-input"
                        type="number"
                        placeholder="threshold"
                      />
                      <input
                        id="activeFilterDeltaVal2"
                        class="filter-input delta-input"
                        type="number"
                        placeholder="to"
                        style="display: none"
                      />
                    </div>
                  </div>
                  <button
                    id="btnResetActiveFilters"
                    class="btn ghost"
                    type="button"
                    title="Reset Filters"
                    aria-label="Reset Promoted Filters"
                  >
                    <svg
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path
                        d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"
                      />
                      <path d="M21 3v5h-5" />
                      <path
                        d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"
                      />
                      <path d="M3 21v-5h5" />
                    </svg>
                  </button>
                </div>
              </div>
              <div class="active-row">
                <div class="staging-actions">
                  <button id="btnDeactivateAll" class="btn danger">
                    Deactivate All
                  </button>
                  <button
                    id="btnDeleteAllActive"
                    class="btn danger"
                    title="Delete all promoted overrides in window"
                    style="margin-left: 8px"
                  >
                    Delete All
                  </button>
                </div>
                <div class="pager-compact pager-right">
                  <label class="small muted pager-size" for="activePageSize">
                    Page Size
                    <select id="activePageSize" aria-label="Active page size">
                      <option value="20">20</option>
                      <option value="50" selected>50</option>
                      <option value="100">100</option>
                    </select>
                  </label>
                  <button
                    id="activePrev"
                    class="btn"
                    aria-label="Previous page"
                  >
                    Previous
                  </button>
                  <span id="activePager" class="muted small">Page 1 / 1</span>
                  <button id="activeNext" class="btn" aria-label="Next page">
                    Next
                  </button>
                </div>
              </div>
            </div>
            <div class="table-scroll-wrap overrides-table-wrap">
              <table id="tblActive">
                <thead>
                  <tr>
                    <th class="col-item">Product</th>
                    <th>Pack Size</th>
                    <th>UOM</th>
                    <th>Region</th>
                    <th>Godown</th>
                    <th>Month</th>
                    <th class="right">Delta Units</th>
                    <th class="col-note">Reason</th>
                    <th class="col-actions center">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- filled by JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- PUBLISH (stub for next step) -->
      <section
        class="tab-panel"
        id="tab-publish"
        role="tabpanel"
        aria-labelledby="tab-btn-publish"
        hidden
      >
        <p class="muted">
          We'll wire snapshotting next (header + lines from combined view).
        </p>
        <div class="row">
          <div>
            <label class="small">Plan Key</label><br />
            <input type="text" id="pubKey" placeholder="Plan 2025-10 (R1)" />
          </div>
          <div>
            <label class="small">As Of</label><br />
            <input type="date" id="pubAsOf" />
          </div>
          <div style="min-width: 260px">
            <label class="small">Notes</label><br />
            <input type="text" id="pubNotes" />
          </div>
          <div>
            <button id="publishSnapshot" class="publish-btn">
              Publish Snapshot
            </button>
          </div>
        </div>
        <div class="grid">
          <table id="publishTable">
            <thead>
              <tr>
                <th>Plan ID</th>
                <th>Key</th>
                <th>As Of</th>
                <th>Created</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- Supabase -->
    <script type="module" src="js/supabaseClient.js"></script>
    <script type="module" src="js/forecast-console.js"></script>
    <!-- Demand Overrides module: provides Staging & Overrides behaviour inside Overrides tab -->
    <script>
      // Enable month window filtering by default for Forecast Console Overrides
      window.DO_DISABLE_MONTH_WINDOW = false;
    </script>
    <script>
      (function () {
        function pad(n) {
          return n < 10 ? "0" + n : String(n);
        }
        function formatYM(d) {
          return d.getFullYear() + "-" + pad(d.getMonth() + 1);
        }
        document.addEventListener("DOMContentLoaded", function () {
          try {
            // Visible inputs now use IDs `fromMonth` and `toMonth` (so the module
            // can find them if desired). Keep a hidden `filterMonth` for
            // backwards-compatible DB equality and notify listeners when the
            // visible window changes.
            var fromEl = document.getElementById("fromMonth");
            var toEl = document.getElementById("toMonth");
            var hiddenEl = document.getElementById("filterMonth");
            if (fromEl && toEl && hiddenEl) {
              var now = new Date();
              var cur = new Date(now.getFullYear(), now.getMonth(), 1);
              var ym = formatYM(cur);
              // Always default both From and To to current month
              fromEl.value = ym;
              toEl.value = ym;

              function syncHiddenAndTrigger() {
                var fromVal = fromEl.value || "";
                var toVal = toEl.value || fromVal;
                hiddenEl.value = fromVal;
                // notify existing listeners in demand-overrides.js which watch 'filterMonth'
                try {
                  hiddenEl.dispatchEvent(
                    new Event("change", { bubbles: true })
                  );
                } catch (e) {
                  /* ignore */
                }
              }

              // Wire change events on the visible window inputs so changing either
              // FROM or TO updates the hidden filter and triggers reloads.
              fromEl.addEventListener("change", syncHiddenAndTrigger);
              toEl.addEventListener("change", syncHiddenAndTrigger);

              // Initial sync: set hidden filterMonth to the current FROM value
              // and notify listeners so initial load aligns to the window.
              syncHiddenAndTrigger();
            }
          } catch (e) {
            console && console.error && console.error(e);
          }
        });
      })();
    </script>
    <script type="module" src="../../js/demand-overrides.js"></script>

    <!-- Forecast Console Modal -->
    <dialog id="fcModal">
      <form method="dialog" style="margin: 0">
        <div style="min-width: 320px; max-width: 560px; padding: 16px 18px">
          <h3 id="fcModalTitle" style="margin: 0 0 8px; font-size: 16px">
            Notice
          </h3>
          <div
            id="fcModalMessage"
            style="margin: 0 0 16px; line-height: 1.4"
          ></div>
          <div style="display: flex; gap: 8px; justify-content: flex-end">
            <button id="fcModalClose" class="btn" value="ok">OK</button>
          </div>
        </div>
      </form>
    </dialog>
  </body>
</html>
