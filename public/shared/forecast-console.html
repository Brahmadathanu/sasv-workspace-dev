<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Forecast Console</title>
    <link rel="stylesheet" href="css/style.css" />
    <style>
      :root {
        --muted: #6b7280;
        --panel-bg: var(--panel-bg, #ffffff);
        --surface-shadow: rgba(15, 23, 42, 0.06);
      }

      body {
        font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
        color: var(--text-color, #111827);
      }

      .fc-wrap {
        max-width: 1360px;
        margin: 0 auto;
        padding: 0 12px 32px;
      }

      .page-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 8px 0 12px;
        gap: 12px;
      }

      .page-header h1 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--primary, #3b82f6);
      }

      .page-lead {
        margin: 0 0 20px;
        color: var(--muted);
        font-size: 0.9rem;
        max-width: 720px;
      }

      .header-actions {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      #homeBtn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        border: 1px solid #fdba74 !important;
        border-radius: 6px;
        background: #fed7aa !important;
        color: #9a3412 !important;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s ease;
      }

      #homeBtn svg {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
      }

      #homeBtn:hover {
        background: #fdba74 !important;
        border-color: #fb923c !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
      }

      .tabs-wrap {
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
        margin: 0 0 18px;
      }

      .tabs {
        display: flex;
        gap: 8px;
        padding: 0 16px;
        background: var(--panel-bg, #fff);
        border: 1px solid rgba(15, 23, 42, 0.08);
        border-radius: 12px;
        box-shadow: 0 10px 24px var(--surface-shadow);
        overflow-x: auto;
        flex: 1 1 auto;
        white-space: nowrap;
        scroll-snap-type: x proximity;
      }

      .tabs::-webkit-scrollbar {
        height: 8px;
      }

      .tabs::-webkit-scrollbar-thumb {
        background: rgba(15, 23, 42, 0.12);
        border-radius: 6px;
      }

      .tabs-chevron {
        width: 34px;
        height: 34px;
        border-radius: 999px;
        border: 1px solid rgba(15, 23, 42, 0.12);
        background: var(--panel-bg, #fff);
        color: var(--muted);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s ease, color 0.2s ease;
      }

      .tabs-chevron svg {
        width: 16px;
        height: 16px;
      }

      .tabs-chevron:hover:not([disabled]) {
        background: #f1f5f9;
        color: #1e3a8a;
      }

      .tabs-chevron[disabled] {
        opacity: 0.35;
        cursor: default;
      }

      .tab-btn {
        display: inline-flex;
        align-items: center;
        gap: 12px;
        padding: 12px 14px;
        border-radius: 10px;
        border: 1px solid transparent;
        background: transparent;
        color: #1f2937;
        font-size: 0.88rem;
        font-weight: 600;
        transition: all 0.2s ease;
        scroll-snap-align: start;
        min-height: 54px;
        text-align: left;
      }

      .tab-btn svg {
        width: 18px;
        height: 18px;
        color: #64748b;
        flex-shrink: 0;
        transition: color 0.2s ease;
      }

      .tab-btn > div {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .tab-description {
        font-size: 0.72rem;
        color: #94a3b8;
        font-weight: 400;
      }

      .tab-btn:hover {
        background: rgba(37, 99, 235, 0.08);
        border-color: rgba(37, 99, 235, 0.16);
        color: #1d4ed8;
      }

      .tab-btn:hover svg {
        color: #2563eb;
      }

      .tab-btn[aria-selected="true"],
      .tab-btn.active {
        background: linear-gradient(
          180deg,
          rgba(37, 99, 235, 0.18),
          rgba(37, 99, 235, 0.08)
        );
        border-color: rgba(37, 99, 235, 0.32);
        color: #1e3a8a;
        box-shadow: 0 8px 20px rgba(37, 99, 235, 0.18);
      }

      .tab-btn[aria-selected="true"] svg,
      .tab-btn.active svg {
        color: #1d4ed8;
      }

      @media (max-width: 720px) {
        .tab-btn {
          gap: 8px;
          padding: 10px 12px;
          min-height: 48px;
        }

        .tab-description {
          display: none;
        }
      }

      .tab-panel {
        display: none;
      }

      .tab-panel.active {
        display: block;
      }

      .tab-panel[hidden] {
        display: none !important;
      }

      .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: flex-end;
        margin-bottom: 12px;
      }

      .tile {
        border: 1px solid rgba(15, 23, 42, 0.08);
        border-radius: 10px;
        padding: 14px 16px;
        min-width: 180px;
        background: var(--panel-bg, #fff);
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
      }

      .tile h4 {
        margin: 0 0 6px;
        font-size: 0.8rem;
        color: #475569;
        letter-spacing: 0.01em;
        text-transform: uppercase;
      }

      .tile .big {
        font-size: 1.45rem;
        font-weight: 700;
      }

      .muted {
        color: var(--muted, #6b7280);
      }

      .warn {
        color: #b45309;
      }

      .ok {
        color: #047857;
      }

      .grid {
        overflow: auto;
        border: 1px solid rgba(15, 23, 42, 0.1);
        border-radius: 12px;
        background: var(--panel-bg, #fff);
        box-shadow: 0 8px 16px rgba(15, 23, 42, 0.05);
      }

      .grid table {
        width: 100%;
        border-collapse: collapse;
        min-width: 720px;
      }

      .grid thead th {
        background: #f8fafc;
        color: #1f2937;
        font-size: 0.75rem;
        font-weight: 600;
        letter-spacing: 0.02em;
        text-transform: uppercase;
        padding: 10px 14px;
        border-bottom: 1px solid rgba(15, 23, 42, 0.1);
      }

      .grid tbody td {
        padding: 10px 14px;
        font-size: 0.85rem;
        border-bottom: 1px solid rgba(15, 23, 42, 0.06);
        color: #111827;
      }

      .grid tbody tr:nth-child(even) {
        background: rgba(148, 163, 184, 0.08);
      }

      .grid tbody tr:hover {
        background: rgba(37, 99, 235, 0.08);
      }

      .section-title {
        margin: 18px 0 12px;
        font-size: 1rem;
        font-weight: 600;
        color: #1f2937;
      }

      #fcModal::backdrop {
        background: rgba(15, 23, 42, 0.45);
      }

      #fcModal {
        border: none;
        border-radius: 10px;
        padding: 0;
      }
    </style>
  </head>
  <body data-theme="system">
    <div class="fc-wrap">
      <header class="page-header">
        <div>
          <h1>Forecast Console</h1>
        </div>
        <div class="header-actions">
          <button id="homeBtn" type="button" title="Home">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              aria-hidden="true"
              focusable="false"
            >
              <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
              <polyline points="9,22 9,12 15,12 15,22" />
            </svg>
            HOME
          </button>
        </div>
      </header>
      <!-- Tabs -->
      <div class="tabs-wrap">
        <button
          class="tabs-chevron left"
          type="button"
          aria-label="Scroll sections left"
        >
          <svg
            width="14"
            height="14"
            viewBox="0 0 24 24"
            fill="none"
            aria-hidden="true"
            focusable="false"
          >
            <path
              d="M15 18l-6-6 6-6"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </button>
        <nav
          class="tabs"
          role="tablist"
          aria-label="Forecast Console Sections"
        >
          <button
            class="tab-btn active"
            id="tab-btn-overview"
            type="button"
            role="tab"
            aria-controls="tab-overview"
            aria-selected="true"
            data-tab="overview"
            tabindex="0"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              aria-hidden="true"
              focusable="false"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M3 12h4v8H3z" />
              <path d="M10 6h4v14h-4z" />
              <path d="M17 3h4v17h-4z" />
            </svg>
            <div>
              Overview
              <span class="tab-description">Health & tracking</span>
            </div>
          </button>

          <button
            class="tab-btn"
            id="tab-btn-outputs"
            type="button"
            role="tab"
            aria-controls="tab-outputs"
            aria-selected="false"
            data-tab="outputs"
            tabindex="-1"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              aria-hidden="true"
              focusable="false"
              stroke="currentColor"
              stroke-width="2"
            >
              <rect x="3" y="4" width="18" height="16" rx="2" />
              <line x1="3" y1="10" x2="21" y2="10" />
              <line x1="9" y1="4" x2="9" y2="20" />
            </svg>
            <div>
              Model Outputs
              <span class="tab-description">Baseline and LLT views</span>
            </div>
          </button>

          <button
            class="tab-btn"
            id="tab-btn-exceptions"
            type="button"
            role="tab"
            aria-controls="tab-exceptions"
            aria-selected="false"
            data-tab="exceptions"
            tabindex="-1"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              aria-hidden="true"
              focusable="false"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
              />
              <path d="M12 9v5" />
              <path d="M12 17h.01" />
            </svg>
            <div>
              Exceptions
              <span class="tab-description">Gaps & outliers to review</span>
            </div>
          </button>

          <button
            class="tab-btn"
            id="tab-btn-overrides"
            type="button"
            role="tab"
            aria-controls="tab-overrides"
            aria-selected="false"
            data-tab="overrides"
            tabindex="-1"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              aria-hidden="true"
              focusable="false"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M3 17v4h4l10-10-4-4L3 17z" />
              <path d="M14 7l4 4" />
            </svg>
            <div>
              Overrides
              <span class="tab-description">Marketing inputs & revisions</span>
            </div>
          </button>

          <button
            class="tab-btn"
            id="tab-btn-publish"
            type="button"
            role="tab"
            aria-controls="tab-publish"
            aria-selected="false"
            data-tab="publish"
            tabindex="-1"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              aria-hidden="true"
              focusable="false"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="7,10 12,5 17,10" />
              <line x1="12" y1="5" x2="12" y2="21" />
            </svg>
            <div>
              Publish
              <span class="tab-description">Snapshot and share plans</span>
            </div>
          </button>
        </nav>
        <button
          class="tabs-chevron right"
          type="button"
          aria-label="Scroll sections right"
        >
          <svg
            width="14"
            height="14"
            viewBox="0 0 24 24"
            fill="none"
            aria-hidden="true"
            focusable="false"
          >
            <path
              d="M9 6l6 6-6 6"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </button>
      </div>
      <!-- Date window + filters (global) -->
      <div class="row">
        <div>
          <label class="small">From</label><br />
          <input type="month" id="fromDate" />
        </div>
        <div>
          <label class="small">To</label><br />
          <input type="month" id="toDate" />
        </div>
        <div>
          <label class="small">SKU</label><br />
          <input type="number" id="skuId" placeholder="(any)" />
        </div>
        <div>
          <label class="small">Region</label><br />
          <input type="number" id="regionId" placeholder="(any)" />
        </div>
        <div>
          <label class="small">Godown</label><br />
          <input type="number" id="godownId" placeholder="(any)" />
        </div>
        <div>
          <button class="btn" id="resetFilters">Reset</button>
        </div>
      </div>

      <!-- OVERVIEW -->
      <section
        class="tab-panel active"
        id="tab-overview"
        role="tabpanel"
        aria-labelledby="tab-btn-overview"
      >
        <h3 class="section-title">Health Summary</h3>
        <div class="row" id="overviewTiles">
          <div class="tile">
            <h4>Window</h4>
            <div class="big" id="tileWindow">--</div>
          </div>
          <div class="tile">
            <h4>Pairs (Combined)</h4>
            <div class="big" id="tilePairs">--</div>
          </div>
          <div class="tile">
            <h4>Rows (Combined)</h4>
            <div class="big" id="tileRows">--</div>
          </div>
          <div class="tile">
            <h4>Missing LLT</h4>
            <div class="big warn" id="tileMissLLT">--</div>
          </div>
          <div class="tile">
            <h4>Missing Seasonal</h4>
            <div class="big warn" id="tileMissSeason">--</div>
          </div>
          <div class="tile">
            <h4>Active Overrides</h4>
            <div class="big ok" id="tileOverrides">--</div>
          </div>
        </div>

        <h3 class="section-title">Latest Runs</h3>
        <div class="grid">
          <table id="runsTable">
            <thead>
              <tr>
                <th>Run ID</th>
                <th>Module</th>
                <th>As Of</th>
                <th>Horizon</th>
                <th>Status</th>
                <th>Created</th>
                <th>Closed</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- MODEL OUTPUTS -->
      <section
        class="tab-panel"
        id="tab-outputs"
        role="tabpanel"
        aria-labelledby="tab-btn-outputs"
        hidden
      >
        <div class="controls">
          <label class="small">Dataset</label>
          <select id="outputsDataset">
            <option value="baseline">Baseline (effective)</option>
            <option value="llt">LLT</option>
            <option value="seasonal">Seasonal</option>
            <option value="combined">Combined Plan</option>
          </select>
          <button class="btn" id="btnLoadOutputs">Load</button>
          <button class="btn ghost" id="btnExportOutputs">Export CSV</button>
          <span class="small muted" id="outputsStatus"></span>
        </div>
        <div class="grid">
          <table id="outputsTable">
            <thead>
              <tr id="outputsHeader"></tr>
            </thead>
            <tbody id="outputsBody"></tbody>
          </table>
        </div>
        <div class="controls">
          <button class="btn" id="prevPageOutputs">Prev</button>
          <span class="small muted" id="pageInfoOutputs">Page 1</span>
          <button class="btn" id="nextPageOutputs">Next</button>
        </div>
      </section>

      <!-- EXCEPTIONS (stub for next step) -->
      <section
        class="tab-panel"
        id="tab-exceptions"
        role="tabpanel"
        aria-labelledby="tab-btn-exceptions"
        hidden
      >
        <p class="muted">
          We'll wire this next: missing LLT/Seasonal, negatives, jumps.
        </p>
        <div class="controls">
          <button class="btn" id="btnLoadExceptions">Load Exceptions</button>
          <button class="btn ghost" id="btnExportExceptions">Export CSV</button>
          <span class="small muted" id="exceptionsStatus"></span>
        </div>
        <div class="grid">
          <table id="exceptionsTable">
            <thead>
              <tr>
                <th>SKU</th>
                <th>Region</th>
                <th>Godown</th>
                <th>Month</th>
                <th>Demand (effective)</th>
                <th>LLT</th>
                <th>Seasonal</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- OVERRIDES -->
      <section
        class="tab-panel"
        id="tab-overrides"
        role="tabpanel"
        aria-labelledby="tab-btn-overrides"
        hidden
      >
        <!-- Run Controls (moved here, only visible in Overrides tab) -->
        <section class="panel" id="runControls">
          <h3>Run Controls</h3>
          <div
            style="
              display: flex;
              gap: 16px;
              flex-wrap: wrap;
              align-items: flex-end;
            "
          >
            <!-- Primary: Apply overrides then LLT+Seasonal -->
            <div>
              <label for="monthsWindow"><small>Months window</small></label
              ><br />
              <input
                id="monthsWindow"
                type="number"
                min="1"
                max="12"
                value="3"
                style="width: 80px"
              />
            </div>
            <div>
              <label for="asOfDate"><small>As-of date (optional)</small></label
              ><br />
              <input id="asOfDate" type="date" />
            </div>
            <div>
              <label for="dryRun"><small>Dry-run</small></label
              ><br />
              <input id="dryRun" type="checkbox" />
            </div>
            <button id="btnApplyOverridesAndDerived" class="btn btn-primary">
              Apply Marketing Overrides -> Re-run LLT & Seasonal
            </button>
            <button id="btnFullRebuild" class="btn btn-danger">
              Full Rebuild: Baseline + LLT + Seasonal
            </button>
          </div>
          <div id="runNotes" class="section-hint" style="margin-top: 8px">
            Tip: Primary button does <b>not</b> re-stat baseline. Full rebuild
            regenerates baseline first.
          </div>
          <div id="runStatus" style="margin-top: 12px">
            <!-- status chips appear here -->
          </div>
        </section>
        <!-- Marketing Overrides: Export/Import -->
        <section class="panel" style="margin-top: 16px">
          <h3>Marketing Overrides</h3>
          <div
            style="
              display: flex;
              gap: 12px;
              align-items: flex-end;
              flex-wrap: wrap;
            "
          >
            <!-- Export -->
            <div>
              <label for="moMonths" style="display: block; font-weight: 600"
                >Export months</label
              >
              <input
                id="moMonths"
                type="number"
                min="1"
                max="12"
                value="3"
                style="width: 90px"
              />
            </div>
            <button id="btnExportBaselineCsv" type="button">
              Export Baseline (CSV)
            </button>

            <!-- Import -->
            <div style="margin-left: 24px">
              <label for="moFile" style="display: block; font-weight: 600"
                >Import CSV</label
              >
              <input id="moFile" type="file" accept=".csv" />
            </div>
            <button id="btnPreviewImport" type="button">Preview</button>
            <button id="btnApplyImport" type="button" disabled>
              Apply Overrides
            </button>

            <!-- Window -->
            <div style="margin-left: auto">
              <label style="display: block; font-weight: 600">Window</label>
              <div style="display: flex; gap: 8px">
                <input id="moFrom" type="month" />
                <input id="moTo" type="month" />
              </div>
              <small
                >Defaults: fence-aware "next 12m". Set only if you need a custom
                window.</small
              >
            </div>
          </div>

          <!-- Import preview table -->
          <div id="moPreview" style="margin-top: 12px; display: none">
            <strong>Import Preview</strong>
            <div
              id="moPreviewInfo"
              style="margin: 6px 0 8px; color: #555"
            ></div>
            <div
              style="
                max-height: 240px;
                overflow: auto;
                border: 1px solid #ddd;
                border-radius: 6px;
              "
            >
              <table id="moPreviewTable" class="data-grid">
                <thead></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Toast -->
        <div
          id="toast"
          style="
            position: fixed;
            right: 16px;
            bottom: 16px;
            background: #111;
            color: #fff;
            padding: 10px 14px;
            border-radius: 8px;
            display: none;
            z-index: 9999;
          "
        ></div>

        <div class="controls">
          <button class="btn" id="btnLoadOverrides">Load</button>
          <button class="btn ghost" id="btnExportOverrides">Export CSV</button>
          <span class="small muted" id="overridesStatus"></span>
        </div>

        <div class="row">
          <div>
            <label class="small">SKU</label><br />
            <input type="number" id="ovSku" />
          </div>
          <div>
            <label class="small">Region</label><br />
            <input type="number" id="ovRegion" />
          </div>
          <div>
            <label class="small">Godown</label><br />
            <input type="number" id="ovGodown" />
          </div>
          <div>
            <label class="small">Month</label><br />
            <input type="month" id="ovMonth" />
          </div>
          <div>
            <label class="small">Delta Units (+/-)</label><br />
            <input type="number" id="ovDelta" />
          </div>
          <div style="min-width: 220px">
            <label class="small">Reason</label><br />
            <input
              type="text"
              id="ovReason"
              placeholder="Marketing commit / campaign / etc."
            />
          </div>
          <div>
            <button class="btn primary" id="btnUpsertOverride">
              Save / Replace
            </button>
          </div>
          <div>
            <button class="btn" id="btnDeleteOverride">Delete</button>
          </div>
        </div>

        <div class="grid">
          <table id="overridesTable">
            <thead>
              <tr>
                <th>SKU</th>
                <th>Region</th>
                <th>Godown</th>
                <th>Month</th>
                <th>Delta Units</th>
                <th>Reason</th>
                <th>Active</th>
                <th>Created</th>
                <th>Updated</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- PUBLISH (stub for next step) -->
      <section
        class="tab-panel"
        id="tab-publish"
        role="tabpanel"
        aria-labelledby="tab-btn-publish"
        hidden
      >
        <p class="muted">
          We'll wire snapshotting next (header + lines from combined view).
        </p>
        <div class="row">
          <div>
            <label class="small">Plan Key</label><br />
            <input type="text" id="pubKey" placeholder="Plan 2025-10 (R1)" />
          </div>
          <div>
            <label class="small">As Of</label><br />
            <input type="date" id="pubAsOf" />
          </div>
          <div style="min-width: 260px">
            <label class="small">Notes</label><br />
            <input type="text" id="pubNotes" />
          </div>
          <div>
            <button id="publishSnapshot" class="publish-btn">
              Publish Snapshot
            </button>
          </div>
        </div>
        <div class="grid">
          <table id="publishTable">
            <thead>
              <tr>
                <th>Plan ID</th>
                <th>Key</th>
                <th>As Of</th>
                <th>Created</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- Supabase -->
    <script type="module" src="js/supabaseClient.js"></script>
    <script type="module" src="js/forecast-console.js"></script>

    <!-- Forecast Console Modal -->
    <dialog id="fcModal">
      <form method="dialog" style="margin: 0">
        <div style="min-width: 320px; max-width: 560px; padding: 16px 18px">
          <h3 id="fcModalTitle" style="margin: 0 0 8px; font-size: 16px">
            Notice
          </h3>
          <div
            id="fcModalMessage"
            style="margin: 0 0 16px; line-height: 1.4"
          ></div>
          <div style="display: flex; gap: 8px; justify-content: flex-end">
            <button id="fcModalClose" class="btn" value="ok">OK</button>
          </div>
        </div>
      </form>
    </dialog>
  </body>
</html>


