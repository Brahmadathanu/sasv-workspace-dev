<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Manage Semi-finished BOM</title>
    <link rel="stylesheet" href="public/shared/css/style.css" />
    <link rel="stylesheet" href="css/shared-ui.css" />
    <style>
      /* Typography & base (align with manage-category-map ERP style) */
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;
        font-size: 14px;
        line-height: 1.35;
      }
      .toolbar {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 10px;
      }
      .toolbar .spacer {
        flex: 1;
      }
      .grid {
        width: 100%;
        border-collapse: collapse;
      }
      .grid th,
      .grid td {
        border: 1px solid var(--border, #e2e8f0);
        padding: 10px 12px;
        font-size: 14px;
      }
      .grid th {
        position: sticky; /* freeze header row */
        top: 0;
        z-index: 2;
        background: var(--table-header, #f1f5f9);
        text-align: left;
        color: #1f2937;
        font-weight: 600;
      }
      /* Center align header cells specifically for the Lines table */
      #linesTable thead th {
        text-align: center;
      }
      .grid tbody tr:nth-child(even) {
        background: #fafafa;
      }
      .grid tbody tr:hover {
        background: #f1f5f9;
      }
      .grid td input,
      .grid td select {
        width: 100%;
        font: inherit;
        padding: 6px 8px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        background: #fff;
      }
      .panel {
        padding: 0;
        background: var(--panel-bg, #fff);
        border: 1px solid var(--border, #e2e8f0);
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
        overflow: hidden;
      }
      .panel-header {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-bottom: 1px solid #e2e8f0;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .panel-header h3 {
        margin: 0;
        font-size: 15px;
        font-weight: 600;
        color: #1e293b;
      }
      .panel-body {
        padding: 16px 16px 18px;
      }
      .two-col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        align-items: start;
      }
      .hint {
        color: var(--muted, #6b7280);
        font-size: 13px;
      }
      label {
        font-size: 13px;
        color: #475569;
        display: grid;
        gap: 6px;
      }
      .danger {
        color: #b91c1c;
      }
      .success {
        color: #166534;
      }
      .pill {
        padding: 6px 10px;
        border: 1px solid rgba(10, 100, 200, 0.2);
        border-radius: 999px;
        background: #f6fbff;
      }
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        background: linear-gradient(135deg, #f8fafc 0%, #eef2f6 100%);
        color: #0f172a;
        font-size: 13px;
        font-weight: 500;
        line-height: 1.2;
        cursor: pointer;
        transition: background 0.15s, border-color 0.15s, box-shadow 0.15s,
          transform 0.15s;
      }
      .btn:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }
      .btn.primary {
        background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        border-color: #0ea5e9;
        color: #fff;
      }
      .btn:hover {
        background: #e2e8f0;
        border-color: #94a3b8;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        transform: translateY(-1px);
      }
      .btn.primary:hover {
        background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
        border-color: #0369a1;
      }
      /* Ensure neutral (ghost) buttons stay grey with dark text */
      .btn.ghost {
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        border-color: #cbd5e1;
        color: #111827; /* keep label dark, not blue */
      }
      .btn.ghost:hover {
        background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
        border-color: #94a3b8;
        color: #111827;
      }
      .btn.ghost:focus {
        outline: 2px solid #94a3b8;
        outline-offset: 2px;
      }
      .btn:focus {
        outline: 2px solid #0ea5e9;
        outline-offset: 2px;
      }
      .btn.primary:focus {
        outline: 2px solid #0284c7;
        outline-offset: 2px;
      }
      .btn.danger {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        border-color: #fca5a5;
        color: #991b1b;
      }
      .btn.danger:hover {
        background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
        border-color: #ef4444;
        color: #7f1d1d;
      }
      .btn.danger:focus {
        outline: 2px solid #ef4444;
        outline-offset: 2px;
      }
      .right {
        text-align: right;
      }
      .nowrap {
        white-space: nowrap;
      }
      .subpanel {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 12px;
      }
      /* Segmented toggle for View/Edit */
      .seg-toggle {
        display: inline-flex;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        overflow: hidden;
        background: #f8fafc;
      }
      .seg-toggle .seg {
        padding: 6px 10px;
        font-size: 12px;
        border: none;
        background: transparent;
        color: #0f172a;
        cursor: pointer;
      }
      .seg-toggle .seg + .seg {
        border-left: 1px solid #cbd5e1;
      }
      .seg-toggle .seg.active {
        background: #0ea5e9;
        color: #ffffff;
      }
      /* Lines panel viewport fit */
      #linesPanel {
        display: flex;
        flex-direction: column;
        max-height: 70vh; /* keep the card within viewport */
        position: relative; /* for back-to-top positioning */
      }
      #linesScroll {
        flex: 1 1 auto;
        overflow-y: auto;
        overflow-x: auto; /* enable horizontal scroll */
        padding: 0; /* ensure grid touches edges as before */
      }
      /* Top horizontal scroll sync bar */
      .hscroll {
        display: none;
        height: 12px;
        overflow-x: auto;
        overflow-y: hidden;
      }
      .hscroll.visible {
        display: block;
      }
      .hscroll-inner {
        height: 1px;
      }
      /* Optional: thin scrollbar styling for horizontal bar */
      .hscroll::-webkit-scrollbar {
        height: 8px;
      }
      .hscroll::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 8px;
      }
      .hscroll::-webkit-scrollbar-track {
        background: #f1f5f9;
      }

      /* Back-to-top floating button */
      #linesBackToTop {
        position: absolute;
        right: 14px;
        bottom: 14px;
        display: none;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: 999px;
        border: 1px solid #cbd5e1;
        background: #ffffff;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        color: #0f172a;
        cursor: pointer;
      }
      #linesBackToTop.show {
        display: inline-flex;
      }
      /* View-mode presentation: center all except item name (now column 3 after adding Code) */
      #linesPanel.view-mode #linesTable th,
      #linesPanel.view-mode #linesTable td {
        text-align: center;
      }
      #linesPanel.view-mode #linesTable td:nth-child(3) {
        text-align: left; /* Stock Item (RM) column */
      }
      /* Hide Actions column in view mode */
      #linesPanel.view-mode #linesTable th:last-child,
      #linesPanel.view-mode #linesTable td:last-child {
        display: none;
      }
      /* First column (SN) layout */
      #linesTable th:first-child,
      #linesTable td:first-child {
        text-align: center;
        width: 56px;
        white-space: nowrap;
      }
      /* Actions column */
      #linesTable th:last-child,
      #linesTable td:last-child {
        text-align: center;
        width: 140px;
        white-space: nowrap;
      }
      .row-actions {
        display: inline-flex;
        gap: 4px;
      }
      .icon-btn.small {
        width: 28px;
        height: 28px;
        padding: 4px;
        border-radius: 6px;
        border: 1px solid #cbd5e1;
        background: #ffffff;
        cursor: pointer;
      }
      .icon-btn.small:hover {
        background: #f1f5f9;
      }
      /* Hide shortcuts help in View mode */
      #linesPanel.view-mode #kbHelpBtn {
        display: none;
      }
      /* Key chip styles for keyboard help popover */
      .kbd-chip {
        display: inline-flex;
        align-items: center;
        gap: 2px;
        padding: 2px 6px;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        background: #f8fafc;
        color: #0f172a;
        font-size: 12px;
        white-space: nowrap;
      }
      .kbd-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 4px 0;
      }
      .kbd-action {
        color: #475569;
        font-size: 12px;
      }
      /* subtle shadow when content scrolled under sticky header */
      #linesScroll.scrolled thead th {
        box-shadow: 0 2px 0 rgba(226, 232, 240, 1),
          0 2px 6px rgba(0, 0, 0, 0.05);
      }
      /* Modal styles */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      .modal {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        width: min(720px, 92vw);
        max-height: 85vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .modal-header {
        padding: 14px 16px;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .modal-header h3 {
        margin: 0;
        font-size: 16px;
        color: #1e293b;
      }
      .modal-body {
        padding: 16px;
        overflow-y: auto;
      }
      .modal-actions {
        padding: 12px 16px;
        border-top: 1px solid #e5e7eb;
        display: flex;
        gap: 8px;
        justify-content: flex-end;
      }
      .form-row {
        display: grid;
        grid-template-columns: 220px 1fr;
        gap: 10px;
        align-items: center;
        margin: 10px 0;
      }
      .form-row .label {
        font-size: 12px;
        letter-spacing: 0.4px;
        text-transform: uppercase;
        color: #64748b;
        font-weight: 600;
      }
      .muted {
        color: #6b7280;
        font-size: 12px;
      }
      /* Prominent product heading styling */
      .product-heading-label {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 15px;
        font-weight: 600;
        color: #0f172a;
        margin: 0;
      }
      .product-heading-label span.title {
        letter-spacing: 0.5px;
        text-transform: uppercase;
        font-size: 12px;
        font-weight: 600;
        color: #64748b;
      }
      .product-heading-label select {
        font-size: 15px;
        font-weight: 600;
        padding: 8px 14px;
        min-width: 240px;
        border: 1px solid #0ea5e9;
        background: #e0f2fe;
        color: #0c4a6e;
        border-radius: 8px;
        outline: none;
        transition: border-color 0.15s, background 0.15s;
      }
      .product-heading-label select:focus {
        border-color: #0369a1;
        background: #cfe9fa;
      }
      .product-heading-label select:hover {
        background: #cfe9fa;
      }
      .icon-btn {
        padding: 6px;
        width: 40px;
        height: 40px;
        justify-content: center;
      }
      .icon-btn svg {
        pointer-events: none;
      }
      .icon-btn .visually-hidden {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0 0 0 0);
        white-space: nowrap;
        border: 0;
      }
      /* Global screen-reader only utility */
      .sr-only {
        position: absolute !important;
        width: 1px !important;
        height: 1px !important;
        padding: 0 !important;
        margin: -1px !important;
        overflow: hidden !important;
        clip: rect(0 0 0 0) !important;
        white-space: nowrap !important;
        border: 0 !important;
      }
      /* ERP pill header display */
      .erp-pills-bar {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-left: 8px;
        flex-wrap: wrap;
      }
      .erp-pill-label {
        font-size: 11px;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        font-weight: 600;
        color: #64748b;
      }
      .erp-pill-chip {
        display: inline-flex;
        align-items: stretch;
        border-radius: 999px;
        overflow: hidden;
        border: 1px solid #0ea5e9;
        background: #0ea5e9; /* base colour behind title segment */
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
      }
      .erp-pill-chip.small {
        /* small variant keeps tighter value min-width */
        font-size: 12px;
      }
      .erp-pill-chip .pill-seg {
        display: inline-flex;
        align-items: center;
        padding: 6px 14px;
        font-weight: 600;
        line-height: 1.2;
        letter-spacing: 0.4px;
        font-size: 13px;
        white-space: nowrap;
      }
      /* Selected cell highlight for view-mode selection (copied from RM BOM for parity) */
      td.cell-selected {
        background: transparent;
        /* base: no visual until we set edge classes */
      }
      /* Edge classes draw the single rectangular border without doubling */
      td.cell-selected.sel-t {
        border-top: 2px solid #f97316;
      }
      td.cell-selected.sel-b {
        border-bottom: 2px solid #f97316;
      }
      td.cell-selected.sel-l {
        border-left: 2px solid #f97316;
      }
      td.cell-selected.sel-r {
        border-right: 2px solid #f97316;
      }
      /* Active (last-selected) cell uses same stroke but a subtle highlight */
      td.cell-active.sel-t {
        border-top: 2px solid #ea580c;
      }
      td.cell-active.sel-b {
        border-bottom: 2px solid #ea580c;
      }
      td.cell-active.sel-l {
        border-left: 2px solid #ea580c;
      }
      td.cell-active.sel-r {
        border-right: 2px solid #ea580c;
      }
      td.cell-active {
        box-shadow: none;
      }
      td.cell-active {
        position: relative;
      }
      /* selection pills use the shared .erp-pill-chip styles above; no selection-specific overrides */
      .erp-pill-chip .pill-seg.title {
        text-transform: uppercase;
        font-size: 10px;
        letter-spacing: 0.6px;
        background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        color: #ffffff;
        border-right: 1px solid rgba(255, 255, 255, 0.3);
      }
      .erp-pill-chip .pill-seg.value {
        background: #f0f9ff;
        color: #0c4a6e;
        font-size: 14px;
        font-weight: 600;
        min-width: 110px;
      }
      .erp-pill-chip.small .pill-seg.value {
        min-width: 70px;
      }
      .erp-pill-chip .pill-seg.value[data-state="empty"] {
        color: #64748b;
      }
      /* Compact QA status chip (small pill with icon) */
      .qa-chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 999px;
        font-weight: 700;
        font-size: 13px;
        min-width: 36px;
        height: 32px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
        background: #f1f5f9;
        color: #0f172a;
        border: 1px solid rgba(15, 23, 42, 0.06);
        cursor: default;
      }
      .qa-chip.ok {
        background: #ecfdf5;
        color: #065f46;
        border-color: #bbf7d0;
      }
      .qa-chip.warn {
        background: #fff7ed;
        color: #92400e;
        border-color: #fed7aa;
      }
      .qa-chip .qa-icon {
        display: inline-flex;
        width: 18px;
        height: 18px;
        align-items: center;
        justify-content: center;
      }
      .qa-popover {
        position: fixed; /* placed near chip using JS */
        z-index: 1300;
        min-width: 260px;
        max-width: 340px;
        background: #ffffff;
        border: 1px solid #e2e8f0;
        box-shadow: 0 6px 18px -2px rgba(0, 0, 0, 0.15),
          0 2px 4px rgba(0, 0, 0, 0.08);
        border-radius: 12px;
        padding: 12px 14px 14px 14px;
        font-size: 13px;
        line-height: 1.35;
        color: #1e293b;
        animation: qaPopIn 140ms cubic-bezier(0.17, 0.67, 0.45, 1.02);
      }
      @keyframes qaPopIn {
        from {
          opacity: 0;
          transform: translateY(-4px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .qa-popover h4 {
        margin: 0 0 8px 0;
        font-size: 14px;
        font-weight: 700;
        color: #0f172a;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .qa-popover ul.qa-issues {
        margin: 0;
        padding-left: 18px;
        max-height: 220px;
        overflow-y: auto;
      }
      .qa-popover ul.qa-issues li.danger {
        color: #dc2626;
      }
      .qa-popover .success-msg {
        margin: 0;
        color: #047857;
        font-weight: 600;
      }
      .qa-popover .qa-popover-close {
        position: absolute;
        top: 6px;
        right: 8px;
        background: none;
        border: none;
        font-size: 18px;
        line-height: 1;
        cursor: pointer;
        color: #64748b;
      }
      .qa-popover .qa-popover-close:focus {
        outline: 2px solid #0ea5e9;
        outline-offset: 2px;
        border-radius: 4px;
      }
      /* Screen loading mask */
      .screen-mask {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.35);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1200;
        backdrop-filter: blur(1px);
      }
      .mask-box {
        display: flex;
        align-items: center;
        gap: 12px;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 14px 16px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.18);
        color: #0f172a;
        font-weight: 600;
      }
      .spinner {
        width: 18px;
        height: 18px;
        border: 2px solid #cbd5e1;
        border-top-color: #0ea5e9;
        border-radius: 50%;
        animation: spin 0.9s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      /* Floating status toast */
      .toast-box {
        position: fixed;
        right: 20px;
        bottom: 20px;
        z-index: 1300;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 360px;
      }
      .toast {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        border-radius: 10px;
        padding: 10px 14px;
        font-size: 13px;
        line-height: 1.4;
        display: flex;
        align-items: flex-start;
        gap: 10px;
        animation: fadeIn 0.25s ease;
      }
      .toast.info {
        border-color: #0ea5e9;
      }
      .toast.success {
        border-color: #16a34a;
      }
      .toast.error {
        border-color: #dc2626;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(6px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .toast-close {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        color: #64748b;
        line-height: 1;
        font-size: 16px;
      }
      .toast-close:hover {
        color: #1e293b;
      }

      /* Kebab menu (vertical ellipsis) */
      .menu-wrap {
        position: relative;
      }
      .menu-panel {
        position: absolute;
        top: 100%;
        right: 0;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.14);
        padding: 6px;
        min-width: 200px;
        display: none;
        z-index: 1100;
      }
      .menu-panel.open {
        display: block;
      }
      .menu-item {
        width: 100%;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        background: transparent;
        border: none;
        border-radius: 8px;
        color: #0f172a;
        font: inherit;
        cursor: pointer;
      }
      .menu-item:hover:not(:disabled) {
        background: #f1f5f9;
      }
      .menu-item:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .menu-item.danger {
        color: #991b1b;
      }
      /* Stock Item Code and Item alignment */
      #linesTable th.code-col,
      #linesTable td.code-cell {
        text-align: center;
        width: 90px;
      }
      #linesTable th.item-col,
      #linesTable td.item-cell {
        text-align: left;
      }
      /* Hide sensitive item name column & toggle when no edit permission */
      body.no-edit #linesTable th.item-col,
      body.no-edit #linesTable td.item-cell {
        display: none;
      }
      body.no-edit .seg-toggle {
        display: none;
      }
      body.no-edit #kbHelpBtn {
        display: none;
      }
      /* Responsive header line layout: wrap gracefully like ERP toolbars */
      .panel-header .hdr-line {
        display: flex;
        align-items: center;
        gap: 12px;
        width: 100%;
      }
      .panel-header .hdr-top {
        flex-wrap: wrap;
      }
      .panel-header .product-heading-label {
        flex: 1 1 240px;
        min-width: 220px;
      }
      .panel-header .product-heading-label select {
        max-width: 100%;
      }
      .panel-header .erp-pills-bar {
        display: flex;
        flex: 2 1 420px;
        gap: 8px;
        min-width: 280px;
        flex-wrap: wrap;
      }
      .panel-header .hdr-actions {
        display: flex;
        gap: 6px;
        margin-left: auto;
        flex: 0 0 auto;
      }
      /* Prevent overflow: allow actions to move to next row on narrow widths */
      @media (max-width: 1100px) {
        .panel-header .erp-pills-bar {
          flex-basis: 100%;
          order: 2;
        }
        .panel-header .hdr-actions {
          order: 3;
          width: 100%;
          justify-content: flex-start;
          margin-left: 0;
          margin-top: 4px;
        }
      }
      @media (max-width: 640px) {
        .panel-header .product-heading-label {
          flex-basis: 100%;
        }
        .panel-header .erp-pills-bar {
          margin-top: 4px;
        }
      }
      /* Improve pill truncation if space is tight */
      .erp-pill-chip .pill-seg.value {
        max-width: 160px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: inline-block;
        vertical-align: bottom;
      }
      /* Kebab menu panel clamp and sizing */
      .menu-panel {
        max-width: 240px;
        box-sizing: border-box;
      }
      /* Use absolute positioning for open state (JS will override to fixed for proper viewport placement) */
      .menu-panel.open {
        position: absolute;
      }
    </style>
    <!-- jsPDF (for PDF export) -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  </head>
  <body data-theme="system">
    <header>
      <div
        style="
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 12px;
        "
      >
        <div>
          <h1 style="margin: 0; text-align: left">Manage Semi-finished BOM</h1>
          <p
            class="hint"
            style="margin: 4px 0 0 0; padding-left: 0; text-align: left"
          >
            Define raw-material composition per product. Header is the standard
            reference output; lines are per reference-output quantity.
          </p>
        </div>
        <div class="header-actions">
          <button
            id="homeBtn"
            type="button"
            onclick="location.href='index.html'"
            style="display: inline-flex; align-items: center; gap: 6px"
          >
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
              <polyline points="9,22 9,12 15,12 15,22" />
            </svg>
            HOME
          </button>
        </div>
      </div>
    </header>

    <section class="panel">
      <div class="panel-header" style="gap: 12px; flex-wrap: wrap">
        <div class="hdr-line hdr-top">
          <label class="product-heading-label">
            <span class="title">Product</span>
            <select id="productPicker"></select>
          </label>
          <!-- Inline ERP pills directly after product selector -->
          <div class="erp-pills-bar">
            <div class="erp-pill-chip" id="pillRefOutputWrap">
              <span class="pill-seg title">Reference Output</span>
              <span id="pillRefOutput" class="pill-seg value" data-state="empty"
                >—</span
              >
            </div>
            <div class="erp-pill-chip small" id="pillLossPctWrap">
              <span class="pill-seg title">Process Loss %</span>
              <span id="pillLossPct" class="pill-seg value" data-state="empty"
                >—</span
              >
            </div>
          </div>
          <div class="hdr-actions">
            <!-- Compact QA status chip (renders validation state) -->
            <button
              id="qaChip"
              type="button"
              class="qa-chip"
              aria-haspopup="true"
              aria-expanded="false"
              aria-controls="qaPopover"
              aria-label="Validation status"
              style="margin-right: 6px; display: none"
            >
              <span class="qa-icon" aria-hidden="true"></span>
            </button>
            <div
              id="qaPopover"
              class="qa-popover"
              role="dialog"
              aria-modal="false"
              aria-labelledby="qaPopoverTitle"
              style="display: none"
            ></div>
            <!-- Export button with dropdown -->
            <div class="menu-wrap" style="margin-right: 4px">
              <button
                id="exportBtn"
                class="btn ghost icon-btn"
                aria-haspopup="true"
                aria-expanded="false"
                aria-controls="exportMenu"
                title="Export BOM (CSV, PDF, HTML)"
              >
                <svg
                  width="22"
                  height="22"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                  <polyline points="7 10 12 15 17 10" />
                  <line x1="12" y1="15" x2="12" y2="3" />
                </svg>
                <span class="visually-hidden">Export</span>
              </button>
              <div
                id="exportMenu"
                class="menu-panel"
                role="menu"
                aria-labelledby="exportBtn"
              >
                <button id="exportCsv" class="menu-item" role="menuitem">
                  Export as CSV
                </button>
                <button id="exportPdf" class="menu-item" role="menuitem">
                  Export as PDF
                </button>
                <button id="exportHtml" class="menu-item" role="menuitem">
                  Export as HTML
                </button>
              </div>
            </div>
            <button
              id="reloadBtn"
              class="btn ghost icon-btn"
              title="Reload current BOM from server"
              aria-label="Reload BOM"
            >
              <svg
                width="26"
                height="26"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polyline points="23 4 23 10 17 10" />
                <polyline points="1 20 1 14 7 14" />
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10" />
                <path d="M20.49 15a9 9 0 0 1-14.85 3.36L1 14" />
              </svg>
              <span class="visually-hidden">Reload</span>
            </button>
            <button
              id="saveBtn"
              class="btn primary icon-btn"
              title="Save BOM header and lines"
              aria-label="Save BOM"
              style="margin-left: 4px"
            >
              <svg
                width="26"
                height="26"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"
                />
                <polyline points="17 21 17 13 7 13 7 21" />
                <polyline points="7 3 7 8 15 8" />
              </svg>
              <span class="visually-hidden">Save</span>
            </button>
            <!-- Kebab menu for header actions -->
            <div class="menu-wrap" style="margin-left: 4px">
              <button
                id="moreMenuBtn"
                class="btn ghost icon-btn"
                aria-haspopup="true"
                aria-expanded="false"
                aria-controls="moreMenu"
                title="More actions"
              >
                <svg
                  width="22"
                  height="22"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <circle cx="12" cy="5" r="1"></circle>
                  <circle cx="12" cy="12" r="1"></circle>
                  <circle cx="12" cy="19" r="1"></circle>
                </svg>
                <span class="visually-hidden">More actions</span>
              </button>
              <div
                id="moreMenu"
                class="menu-panel"
                role="menu"
                aria-labelledby="moreMenuBtn"
              >
                <button id="cloneBtn" class="menu-item" role="menuitem">
                  New Header
                </button>
                <button
                  id="editHeaderBtn"
                  class="menu-item"
                  role="menuitem"
                  disabled
                >
                  Edit Header
                </button>
                <hr
                  style="
                    border: none;
                    border-top: 1px solid #e5e7eb;
                    margin: 6px 4px;
                  "
                />
                <button
                  id="deleteBtn"
                  class="menu-item danger"
                  role="menuitem"
                  disabled
                >
                  Delete Header
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="panel-body">
        <!-- Hidden controls retained for logic and saving -->
        <input
          id="refQty"
          type="number"
          step="0.001"
          min="0"
          readonly
          class="sr-only"
        />
        <select id="refUom" disabled class="sr-only"></select>
        <input
          id="lossPct"
          type="number"
          step="0.01"
          min="0"
          max="100"
          readonly
          class="sr-only"
        />
        <div class="subpanel" style="margin-top: 4px; display: none">
          <h3 style="margin: 0 0 10px 0; font-size: 15px; color: #1e293b">
            Quick Checks
          </h3>
          <ul
            id="qaList"
            class="hint"
            style="margin: 0; padding-left: 18px"
          ></ul>
        </div>
      </div>
    </section>

    <section id="linesPanel" class="panel view-mode">
      <div class="panel-header">
        <h3>Lines</h3>
        <div
          id="selectionPills"
          class="erp-pills-bar"
          style="
            flex: 1;
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: flex-start;
            margin-left: 12px;
          "
        ></div>
        <div style="display: flex; gap: 8px; align-items: center">
          <div class="seg-toggle" role="group" aria-label="Lines mode">
            <button id="linesViewBtn" class="seg active" type="button">
              View
            </button>
            <button id="linesEditBtn" class="seg" type="button">Edit</button>
          </div>
          <button
            id="kbHelpBtn"
            class="btn ghost icon-btn small"
            type="button"
            aria-label="Keyboard shortcuts"
            style="margin-left: 4px"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
            >
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 2-3 4"></path>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            <span class="visually-hidden">Keyboard shortcuts</span>
          </button>
        </div>
      </div>
      <div id="linesHScrollTop" class="hscroll" aria-hidden="true">
        <div id="linesHScrollInner" class="hscroll-inner"></div>
      </div>
      <div id="linesScroll" class="panel-body" style="padding: 0">
        <table class="grid" id="linesTable" style="margin: 0">
          <thead>
            <tr>
              <th class="nowrap">SN</th>
              <th class="nowrap code-col">Stock Item Code</th>
              <th class="item-col">Stock Item (RM)</th>
              <th class="right">Qty per Ref</th>
              <th>UOM</th>
              <th class="right">Wastage</th>
              <th>Optional</th>
              <th>Remarks</th>
              <th class="nowrap">Actions</th>
            </tr>
          </thead>
          <tbody id="linesBody"></tbody>
        </table>
      </div>
      <!-- Hint removed as requested -->
      <button id="linesBackToTop" title="Back to top" aria-label="Back to top">
        <svg
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <polyline points="18 15 12 9 6 15" />
        </svg>
      </button>
    </section>

    <!-- New Header / Clone Lines Modal -->
    <div
      id="newHeaderModal"
      class="modal-backdrop"
      role="dialog"
      aria-modal="true"
      aria-labelledby="newHeaderTitle"
    >
      <div class="modal">
        <div class="modal-header">
          <h3 id="newHeaderTitle">New Header / Clone Lines</h3>
          <button id="nhCloseBtn" class="btn ghost" aria-label="Close">
            Close
          </button>
        </div>
        <div class="modal-body">
          <div class="form-row">
            <div class="label">Product</div>
            <div>
              <select id="nhProduct"></select>
              <div class="muted">Choose the product for the new header.</div>
            </div>
          </div>
          <div class="form-row">
            <div class="label">Reference Output Qty</div>
            <div>
              <input
                id="nhRefQty"
                type="number"
                step="0.001"
                min="0"
                value="1.000"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="label">Reference Output UOM</div>
            <div><select id="nhRefUom"></select></div>
          </div>
          <div class="form-row">
            <div class="label">Process Loss %</div>
            <div>
              <input
                id="nhLossPct"
                type="number"
                step="0.01"
                min="0"
                max="100"
              />
              <div class="muted">Enter percent, e.g., 5 for 5%.</div>
            </div>
          </div>
          <hr
            style="border: none; border-top: 1px solid #e5e7eb; margin: 14px 0"
          />
          <div class="form-row">
            <div class="label">Clone Lines</div>
            <div>
              <label style="display: flex; align-items: center; gap: 8px">
                <input id="nhCloneToggle" type="checkbox" /> Enable cloning from
                existing BOM
              </label>
              <div id="nhCloneSection" style="margin-top: 8px; display: none">
                <select id="nhCloneProduct"></select>
                <div class="muted">
                  Lines will be copied from this product’s BOM if available.
                  Header values above remain as entered.
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-actions">
          <button id="nhCancelBtn" class="btn ghost">Cancel</button>
          <button id="nhCreateBtn" class="btn primary">Initialize</button>
        </div>
      </div>
    </div>

    <!-- Delete Header Confirm Modal -->
    <div
      id="deleteHeaderModal"
      class="modal-backdrop"
      role="dialog"
      aria-modal="true"
      aria-labelledby="deleteHeaderTitle"
    >
      <div class="modal">
        <div class="modal-header">
          <h3 id="deleteHeaderTitle">Delete Header</h3>
          <button id="dhCloseBtn" class="btn ghost" aria-label="Close">
            Close
          </button>
        </div>
        <div class="modal-body">
          <p class="danger" style="margin-top: 0; font-weight: 600">
            This action is permanent.
          </p>
          <p>
            You are about to delete the BOM header for product:
            <strong id="dhProductName"></strong>.
          </p>
          <ul>
            <li>All its lines will be deleted (cascade delete).</li>
            <li>This cannot be undone.</li>
          </ul>
        </div>
        <div class="modal-actions">
          <button id="dhCancelBtn" class="btn ghost">Cancel</button>
          <button id="dhConfirmBtn" class="btn danger">Confirm Delete</button>
        </div>
      </div>
    </div>

    <!-- Delete Line Confirm Modal -->
    <div
      id="deleteLineModal"
      class="modal-backdrop"
      role="dialog"
      aria-modal="true"
      aria-labelledby="deleteLineTitle"
    >
      <div class="modal" style="width: min(420px, 92vw)">
        <div class="modal-header">
          <h3 id="deleteLineTitle">Delete Line</h3>
          <button id="dlCloseBtn" class="btn ghost" aria-label="Close">
            Close
          </button>
        </div>
        <div class="modal-body">
          <p id="dlText" style="margin: 0 0 8px 0">
            Are you sure you want to delete this line?
          </p>
        </div>
        <div class="modal-actions">
          <button id="dlCancelBtn" class="btn ghost">Cancel</button
          ><button id="dlConfirmBtn" class="btn danger">Delete</button>
        </div>
      </div>
    </div>

    <!-- Tiny insert-count popover -->
    <div
      id="insertPopover"
      class="mini-popover"
      style="display: none; position: absolute; z-index: 1400"
    >
      <div
        style="
          background: #fff;
          border: 1px solid #e5e7eb;
          border-radius: 10px;
          box-shadow: 0 10px 24px rgba(0, 0, 0, 0.14);
          padding: 8px;
          min-width: 170px;
        "
      >
        <div style="font-size: 12px; color: #475569; margin-bottom: 6px">
          Insert how many rows?
        </div>
        <div
          style="
            display: flex;
            gap: 6px;
            align-items: center;
            margin-bottom: 8px;
          "
        >
          <input
            id="insCountInput"
            type="number"
            min="1"
            max="100"
            value="1"
            style="
              width: 70px;
              padding: 4px 6px;
              border: 1px solid #cbd5e1;
              border-radius: 6px;
            "
          />
          <div style="display: flex; gap: 4px">
            <button class="btn ghost" data-q="1" style="padding: 4px 8px">
              1
            </button>
            <button class="btn ghost" data-q="2" style="padding: 4px 8px">
              2
            </button>
            <button class="btn ghost" data-q="5" style="padding: 4px 8px">
              5
            </button>
            <button class="btn ghost" data-q="10" style="padding: 4px 8px">
              10
            </button>
          </div>
        </div>
        <div style="display: flex; gap: 6px; justify-content: flex-end">
          <button id="insCancelBtn" class="btn ghost">Cancel</button>
          <button id="insOkBtn" class="btn primary">Insert</button>
        </div>
      </div>
    </div>

    <!-- Keyboard shortcuts help popover -->
    <div
      id="kbHelpPopover"
      class="mini-popover"
      style="display: none; position: absolute; z-index: 1400"
      role="dialog"
      aria-label="Keyboard shortcuts"
    >
      <div
        style="
          background: #fff;
          border: 1px solid #e5e7eb;
          border-radius: 10px;
          box-shadow: 0 10px 24px rgba(0, 0, 0, 0.14);
          padding: 10px 12px;
          min-width: 260px;
        "
      >
        <div class="kbd-row">
          <span class="kbd-chip">Alt</span><span>+</span
          ><span class="kbd-chip">↑</span
          ><span class="kbd-action">Move row up</span>
        </div>
        <div class="kbd-row">
          <span class="kbd-chip">Alt</span><span>+</span
          ><span class="kbd-chip">↓</span
          ><span class="kbd-action">Move row down</span>
        </div>
        <div class="kbd-row">
          <span class="kbd-chip">Insert</span
          ><span class="kbd-action">Insert below</span>
        </div>
        <div class="kbd-row">
          <span class="kbd-chip">Shift</span><span>+</span
          ><span class="kbd-chip">Insert</span
          ><span class="kbd-action">Insert above (popover)</span>
        </div>
        <div class="kbd-row">
          <span class="kbd-chip">Delete</span
          ><span class="kbd-action">Delete row</span>
        </div>
      </div>
    </div>

    <!-- Edit Header Modal -->
    <div
      id="editHeaderModal"
      class="modal-backdrop"
      role="dialog"
      aria-modal="true"
      aria-labelledby="editHeaderTitle"
    >
      <div class="modal">
        <div class="modal-header">
          <h3 id="editHeaderTitle">Edit Header</h3>
          <button id="ehCloseBtn" class="btn ghost" aria-label="Close">
            Close
          </button>
        </div>
        <div class="modal-body">
          <div class="form-row">
            <div class="label">Reference Output Qty</div>
            <div>
              <input id="ehRefQty" type="number" step="0.001" min="0" />
            </div>
          </div>
          <div class="form-row">
            <div class="label">Reference Output UOM</div>
            <div><select id="ehRefUom"></select></div>
          </div>
          <div class="form-row">
            <div class="label">Process Loss %</div>
            <div>
              <input
                id="ehLossPct"
                type="number"
                step="0.01"
                min="0"
                max="100"
              />
            </div>
          </div>
          <div class="form-row" style="align-items: start">
            <div class="label">Notes</div>
            <div>
              <textarea
                id="ehNotes"
                rows="3"
                style="width: 100%; resize: vertical"
              ></textarea>
            </div>
          </div>
          <p class="muted" style="margin: 10px 0 0 0">
            Changes apply locally; press Save to persist to server.
          </p>
        </div>
        <div class="modal-actions">
          <button id="ehCancelBtn" class="btn ghost">Cancel</button
          ><button id="ehApplyBtn" class="btn primary">Apply</button>
        </div>
      </div>
    </div>

    <script type="module" src="public/shared/js/supabaseClient.js"></script>
    <script type="module" src="js/manage-sp-bom.js"></script>

    <!-- Loading Mask -->
    <div id="pageMask" class="screen-mask" aria-live="polite" aria-busy="true">
      <div class="mask-box">
        <div class="spinner" aria-hidden="true"></div>
        <div id="pageMaskText">Loading…</div>
      </div>
    </div>
    <!-- Floating Status Toast Container -->
    <div id="statusToastContainer" class="toast-box" aria-live="polite"></div>
  </body>
</html>
