<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>SASV WORKSPACE</title>
    <link rel="stylesheet" href="public/shared/css/style.css" />
    <style>
      /* Link-like logout button */
      #logoutLink {
        background: none;
        border: none;
        padding: 0;
        font: inherit;
        color: blue;
        text-decoration: underline;
        cursor: pointer;
      }
      #logoutLink:hover {
        opacity: 0.8;
      }
      #logoutLink:focus {
        outline: 2px solid #007cff;
        outline-offset: 2px;
      }

      /* Online bubbles */
      .online-bubble {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: var(--bubble-bg);
        color: #fff;
        font-size: 12px;
        margin-right: 4px;
        position: relative;
        cursor: default;
        user-select: none;
      }
      .online-bubble .tooltip {
        position: absolute;
        top: -32px;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: #fff;
        padding: 4px 8px;
        border-radius: 4px;
        white-space: nowrap;
        font-size: 11px;
        visibility: hidden;
        opacity: 0;
        z-index: 10;
        transition: opacity 0.1s;
      }
      .online-bubble:hover .tooltip {
        visibility: visible;
        opacity: 1;
      }

      body {
        overflow-x: hidden;
      }
      #userBar {
        display: flex;
        align-items: center;
      }
      #onlineUsersContainer {
        margin-left: auto;
      }

      /* Section helper text */
      .section-hint {
        margin: 6px 0 12px;
        color: var(--muted, #6b7280);
        font-size: 0.95rem;
      }

      /* Placeholder (coming-soon) links */
      .module-link[aria-disabled="true"] {
        pointer-events: none;
        opacity: 0.55;
        text-decoration: none;
        cursor: not-allowed;
      }

      /* Module search — modern, compact pill */
      #module-search-container {
        margin: 12px 0 18px 0;
        display: flex;
        justify-content: center; /* center the search */
        align-items: center;
        pointer-events: auto;
      }
      #moduleSearch {
        width: 100%;
        max-width: 760px;
        padding: 10px 14px 10px 44px; /* room for icon */
        /* clearer, slightly bluish border to differentiate the field */
        border: 1px solid rgba(10, 100, 200, 0.12);
        border-radius: 9999px; /* pill */
        font-size: 15px;
        /* distinct pale background for quick identification */
        background: #f6fbff
          url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236b7f88' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='7'/%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'/%3E%3C/svg%3E")
          no-repeat 14px center/18px;
        /* subtle inner highlight to make the pill feel crisp */
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
        outline: none;
        transition: border-color 0.12s, transform 0.06s, background-color 0.12s;
      }
      #moduleSearch:focus {
        border-color: rgba(10, 100, 200, 0.28);
        background: #fff; /* inverse on focus for clarity */
        box-shadow: none;
        /* subtle focus ring for accessibility */
        outline: 2px solid rgba(10, 100, 200, 0.06);
        outline-offset: 2px;
      }
      #moduleSearch::placeholder {
        color: #98a6ad;
      }
    </style>
  </head>
  <body data-theme="system">
    <header>
      <h1>SASV WORKSPACE <small id="appVersion"></small></h1>

      <div id="userBar">
        <span id="userInfo">Loading…</span>
        &nbsp;|&nbsp;
        <button id="logoutLink" type="button">Log Out</button>
        <span id="onlineUsersContainer"></span>
      </div>
    </header>

    <!-- Module search (type-to-navigate) -->
    <div id="module-search-container">
      <input
        id="moduleSearch"
        list="module-list-datalist"
        placeholder="Jump to module… (type to search)"
        autocomplete="off"
      />
      <datalist id="module-list-datalist"></datalist>
    </div>

    <!-- Work Log -->
    <section class="panel">
      <h2>Work Log</h2>
      <p class="section-hint">
        Daily operational notes, task tracking, and activity history.
      </p>
      <div class="module-list">
        <a
          class="module-link"
          data-module-id="add-log-entry"
          href="add-log-entry.html"
          >Add Log Entry</a
        >
        <a
          class="module-link"
          data-module-id="update-log-status"
          href="update-log-status.html"
          >Update Log Status</a
        >
        <a
          class="module-link"
          data-module-id="edit-log-entry"
          href="edit-log-entry.html"
          >Edit Log Entry</a
        >
        <a
          class="module-link"
          data-module-id="view-logs"
          href="public/shared/view-logs.html"
          >View Logs</a
        >
        <a
          class="module-link"
          data-module-id="manage-activities"
          href="manage-activities.html"
          >Manage Activities</a
        >
      </div>
    </section>

    <!-- Planning Workspace -->
    <section class="panel">
      <h2>Planning Workspace</h2>
      <p class="section-hint">
        Plan demand with model outputs, review exceptions, apply overrides, and
        publish the final plan.
      </p>
      <div class="module-list">
        <a
          class="module-link"
          data-module-id="forecast-console"
          href="public/shared/forecast-console.html"
          >Forecast Console</a
        >
        <a
          class="module-link"
          data-module-id="demand-overrides"
          href="public/shared/demand-overrides.html"
          >Demand Overrides</a
        >
        <a
          class="module-link"
          data-module-id="seasonality-constraints"
          href="#"
          aria-disabled="true"
          title="Coming soon"
          >Seasonality & Constraints</a
        >
        <a
          class="module-link"
          data-module-id="planning-scenarios"
          href="#"
          aria-disabled="true"
          title="Coming soon"
          >Scenarios</a
        >
      </div>
    </section>

    <!-- MRP & Procurement -->
    <section class="panel">
      <h2>MRP & Procurement</h2>
      <p class="section-hint">
        Convert the published plan into material requirements and purchase
        actions.
      </p>
      <div class="module-list">
        <a
          class="module-link"
          data-module-id="mrp-explosion"
          href="#"
          aria-disabled="true"
          title="Coming soon"
          >MRP Explosion</a
        >
        <a
          class="module-link"
          data-module-id="purchase-suggestions"
          href="#"
          aria-disabled="true"
          title="Coming soon"
          >Purchase Suggestions</a
        >
        <a
          class="module-link"
          data-module-id="material-indents"
          href="#"
          aria-disabled="true"
          title="Coming soon"
          >Material Indents</a
        >
        <a
          class="module-link"
          data-module-id="vendor-material"
          href="#"
          aria-disabled="true"
          title="Coming soon"
          >Vendor ↔ Material</a
        >
        <a
          class="module-link"
          data-module-id="plant-occupancy"
          href="public/shared/plant-occupancy.html"
        >
          Plant / Machinery Occupancy
        </a>
      </div>
    </section>

    <!-- Inventory & Sales Analytics -->
    <section class="panel">
      <h2>Inventory & Sales Analytics</h2>
      <p class="section-hint">
        Operational checks to defend the plan—coverage, risk, and trends.
      </p>
      <div class="module-list">
        <a
          class="module-link"
          data-module-id="inventory-coverage"
          href="#"
          aria-disabled="true"
          title="Coming soon"
          >Inventory Coverage</a
        >
        <a
          class="module-link"
          data-module-id="stockouts-risk"
          href="#"
          aria-disabled="true"
          title="Coming soon"
          >Stockouts & At-Risk</a
        >
        <a
          class="module-link"
          data-module-id="sales-data-viewer"
          href="public/shared/sales-viewer.html"
        >
          Sales Viewer
        </a>
        <a
          class="module-link"
          data-module-id="sales-runrate"
          href="#"
          aria-disabled="true"
          title="Coming soon"
          >Sales Run-Rate</a
        >
        <a
          class="module-link"
          data-module-id="wip-stock"
          href="public/shared/wip-stock.html"
        >
          WIP Stock
        </a>
        <a
          class="module-link"
          data-module-id="fg-bulk-stock"
          href="public/shared/fg-bulk-stock.html"
        >
          FG Bulk Stock
        </a>
        <a
          class="module-link"
          data-module-id="bottled-stock"
          href="public/shared/bottled-stock.html"
        >
          Bottled Stock
        </a>
        <a
          class="module-link"
          data-module-id="bmr-card-not-initiated"
          href="public/shared/bmr-card-not-initiated.html"
        >
          BMR Card – Not Initiated
        </a>
      </div>
    </section>

    <!-- Product & Reference Master -->
    <section class="panel">
      <h2>Product & Reference Master</h2>
      <p class="section-hint">
        Single source of truth for products, SKUs, costing, and reference
        publications.
      </p>
      <div class="module-list">
        <a
          class="module-link"
          data-module-id="manage-products"
          href="manage-products.html"
          >Products</a
        >
        <a
          class="module-link"
          data-module-id="manage-skus"
          href="#"
          aria-disabled="true"
          title="Coming soon"
          >SKUs</a
        >
        <a
          class="module-link"
          data-module-id="manage-cost-sheets"
          href="#"
          aria-disabled="true"
          title="Coming soon"
          >Cost Sheets</a
        >

        <a
          class="module-link"
          data-module-id="manage-categories"
          href="manage-categories.html"
          >Categories</a
        >
        <a
          class="module-link"
          data-module-id="manage-subcategories"
          href="manage-subcategories.html"
          >Sub-categories</a
        >
        <a
          class="module-link"
          data-module-id="manage-product-groups"
          href="manage-product-groups.html"
          >Groups</a
        >
        <a
          class="module-link"
          data-module-id="manage-subgroups"
          href="manage-subgroups.html"
          >Sub-groups</a
        >

        <a
          class="module-link"
          data-module-id="manage-references"
          href="manage-references.html"
          >References</a
        >
        <a
          class="module-link"
          data-module-id="manage-publications"
          href="manage-publications.html"
          >Publications</a
        >
        <a
          class="module-link"
          data-module-id="manage-chapters"
          href="manage-chapters.html"
          >Chapters</a
        >
      </div>
    </section>

    <!-- Plant & Assets -->
    <section class="panel">
      <h2>Plant & Assets</h2>
      <p class="section-hint">
        Physical manufacturing structure—sections, areas, machines, and types.
      </p>
      <div class="module-list">
        <a
          class="module-link"
          data-module-id="manage-sections"
          href="manage-sections.html"
          >Sections</a
        >
        <a
          class="module-link"
          data-module-id="manage-subsections"
          href="manage-subsections.html"
          >Sub-sections</a
        >
        <a
          class="module-link"
          data-module-id="manage-areas"
          href="manage-areas.html"
          >Areas</a
        >
        <a
          class="module-link"
          data-module-id="manage-plants"
          href="manage-plants.html"
          >Plants/Machinery</a
        >
        <a
          class="module-link"
          data-module-id="manage-machine-types"
          href="manage-machine-types.html"
          >Machine Types</a
        >
      </div>
    </section>

    <!-- BMR & Production Records -->
    <section class="panel">
      <h2>BMR & Production Records</h2>
      <p class="section-hint">
        Batch manufacturing records and production traceability.
      </p>
      <div class="module-list">
        <a
          class="module-link"
          data-module-id="add-bmr-entry"
          href="add-bmr-entry.html"
          >Add BMR</a
        >
        <a
          class="module-link"
          data-module-id="edit-bmr-entry"
          href="edit-bmr-entry.html"
          >Edit BMR</a
        >
        <a
          class="module-link"
          data-module-id="view-bmr-entry"
          href="view-bmr-entry.html"
          >View BMR</a
        >
      </div>
    </section>

    <!-- SOPs -->
    <section class="panel">
      <h2>SOPs</h2>
      <p class="section-hint">
        Standard operating procedures: draft, review, and publish.
      </p>
      <div class="module-list">
        <a
          class="module-link"
          data-module-id="sop-dashboard"
          href="sop-dashboard.html"
          >SOP Dashboard</a
        >
        <a
          class="module-link"
          data-module-id="sop-editor"
          href="sop-editor.html"
          >New / Edit SOP</a
        >
        <a
          class="module-link"
          data-module-id="sop-viewer"
          href="sop-viewer.html"
          >View SOP</a
        >
      </div>
    </section>

    <!-- System & Integrations -->
    <section class="panel">
      <h2>System & Integrations</h2>
      <p class="section-hint">Operations, pipelines, and helper tools.</p>
      <div class="module-list">
        <!-- Renamed: ETL → Operations -->
        <a
          class="module-link"
          data-module-id="operations-monitor"
          href="public/shared/operations-monitor.html"
          >Operations Monitor</a
        >
        <a
          class="module-link"
          data-module-id="operations-control"
          href="public/shared/operations-control.html"
          >Operations Control</a
        >

        <a
          class="module-link"
          data-module-id="fill-planner"
          href="public/shared/fill-planner.html"
          >Fill Planner</a
        >
        <a
          class="module-link"
          data-module-id="stock-checker"
          href="public/shared/stock-checker.html"
          >Stock Checker</a
        >
      </div>
    </section>

    <!-- Supabase & Init -->
    <script>
      // Module search helper
      (function () {
        const input = document.getElementById("moduleSearch");
        const list = document.getElementById("module-list-datalist");

        function buildIndex() {
          // Gather visible module links and build a simple index of {label, href, id}
          const anchors = Array.from(document.querySelectorAll("a.module-link"))
            .filter((a) => a.style.display !== "none")
            .map((a) => ({
              label: (a.textContent || a.innerText || "").trim(),
              href: a.getAttribute("href"),
              id: a.dataset.moduleId || "",
              disabled: a.getAttribute("aria-disabled") === "true",
            }))
            .filter((a) => a.label);

          // Clear datalist
          list.innerHTML = "";

          // Add options: value uses label, we encode href and id in data-attrs via value marker
          anchors.forEach((a) => {
            const opt = document.createElement("option");
            opt.value = a.label;
            // store a JSON payload on dataset to retrieve later
            opt.dataset.payload = JSON.stringify({
              href: a.href,
              id: a.id,
              disabled: a.disabled,
            });
            list.appendChild(opt);
          });

          // also expose the index for more advanced matching
          input._moduleIndex = anchors;
        }

        function findBest(label) {
          if (!label) return null;
          const idx = input._moduleIndex || [];
          const q = label.trim().toLowerCase();
          // exact match first
          let hit = idx.find((x) => x.label.toLowerCase() === q);
          if (hit) return hit;
          // prefix match
          hit = idx.find((x) => x.label.toLowerCase().startsWith(q));
          if (hit) return hit;
          // substring match
          hit = idx.find((x) => x.label.toLowerCase().includes(q));
          return hit || null;
        }

        function navigateToModuleByLabel(label) {
          const hit = findBest(label);
          if (!hit) return false;
          if (hit.disabled) return false;
          // navigate: if href starts with http/ or / treat as absolute, else relative
          window.location.href = hit.href;
          return true;
        }

        // Rebuild on DOMContentLoaded and when permissions hide/show modules
        window.addEventListener("DOMContentLoaded", buildIndex);
        // also observe for DOM changes to module-list areas
        const observer = new MutationObserver(() => buildIndex());
        document
          .querySelectorAll(".module-list")
          .forEach((el) =>
            observer.observe(el, { childList: true, subtree: true })
          );

        // Key handling: Enter navigates
        input?.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            const v = input.value || "";
            if (!v) return;
            navigateToModuleByLabel(v);
          }
        });

        // When user selects an option from the datalist, the input value will
        // equal one of the indexed labels; detect that and navigate immediately.
        input?.addEventListener("input", (e) => {
          const v = (input.value || "").trim();
          if (!v) return;
          const idx = input._moduleIndex || [];
          const exact = idx.find(
            (x) => x.label.toLowerCase() === v.toLowerCase()
          );
          if (exact && !exact.disabled) {
            // small delay to allow browser selection to finalize
            setTimeout(() => navigateToModuleByLabel(v), 0);
          }
        });

        // Go button removed — navigation handled on selection/Enter

        // Optional: open datalist options on focus
        input?.addEventListener("focus", () =>
          input.setAttribute("list", "module-list-datalist")
        );
      })();
    </script>
    <script type="module" src="public/shared/js/supabaseClient.js"></script>
    <script type="module">
      import { supabase } from "../public/shared/js/supabaseClient.js";

      async function initApp() {
        try {
          const {
            data: { session },
          } = await supabase.auth.getSession();
          if (!session) return (window.location.href = "login.html");

          const {
            data: { user },
          } = await supabase.auth.getUser();

          // presence constants
          const PRESENCE_REFRESH_MS = 20_000;
          const ONLINE_THRESHOLD_MS = 60_000;

          async function sendHeartbeat(u) {
            await supabase.from("user_presence").upsert(
              {
                user_id: u.id,
                email: u.email,
                last_seen: new Date().toISOString(),
              },
              { onConflict: "user_id" }
            );
          }
          async function getOnlineUsers() {
            const cutoff = new Date(
              Date.now() - ONLINE_THRESHOLD_MS
            ).toISOString();
            const { data: users, error } = await supabase
              .from("user_presence")
              .select("user_id,email,last_seen")
              .gt("last_seen", cutoff)
              .order("last_seen", { ascending: false });
            if (error) {
              console.error("Failed to fetch online users", error);
              return [];
            }
            return users || [];
          }

          function colorFromString(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++)
              hash = str.charCodeAt(i) + ((hash << 5) - hash);
            const hue = Math.abs(hash) % 360;
            return `hsl(${hue}, 65%, 60%)`;
          }
          function initialsFromEmail(email) {
            const name = email.split("@")[0];
            const parts = name.split(/[._-]/).filter(Boolean);
            return (
              parts.length >= 2 ? parts[0][0] + parts[1][0] : name.slice(0, 2)
            ).toUpperCase();
          }
          function renderOnlineBubbles(users) {
            const container = document.getElementById("onlineUsersContainer");
            if (!container) return;
            container.innerHTML = "";
            users.forEach((u) => {
              const bubble = document.createElement("div");
              bubble.className = "online-bubble";
              bubble.textContent = initialsFromEmail(u.email);
              bubble.style.setProperty("--bubble-bg", colorFromString(u.email));
              const tooltip = document.createElement("div");
              tooltip.className = "tooltip";
              tooltip.textContent = u.email;
              bubble.appendChild(tooltip);
              bubble.addEventListener("mouseenter", () => fitTooltip(tooltip));
              bubble.addEventListener("focus", () => fitTooltip(tooltip));
              container.appendChild(bubble);
              fitTooltip(tooltip);
            });
          }
          function fitTooltip(tooltip) {
            const rect = tooltip.getBoundingClientRect();
            const gap = 6;
            if (rect.right > window.innerWidth) {
              const overshoot = rect.right - window.innerWidth + gap;
              tooltip.style.transform = `translateX(calc(-50% - ${overshoot}px))`;
            }
            if (rect.left < 0) {
              const overshoot = Math.abs(rect.left) + gap;
              tooltip.style.transform = `translateX(calc(-50% + ${overshoot}px))`;
            }
          }

          const userInfoEl = document.getElementById("userInfo");
          const logoutEl = document.getElementById("logoutLink");
          if (!userInfoEl || !logoutEl) return;
          userInfoEl.textContent = `Logged in as ${user.email}`;

          // presence: startup & polling
          await sendHeartbeat(user);
          setInterval(() => sendHeartbeat(user), PRESENCE_REFRESH_MS);
          async function refreshOnlineDisplay() {
            const onlineUsers = await getOnlineUsers();
            renderOnlineBubbles(onlineUsers);
          }
          refreshOnlineDisplay();
          setInterval(refreshOnlineDisplay, 30_000);

          // cleanup on window close (best effort)
          window.addEventListener("beforeunload", () => {
            supabase.from("user_presence").delete().eq("user_id", user.id);
          });

          // logout: ensure presence deletion first
          logoutEl.replaceWith(logoutEl.cloneNode(true));
          const freshLogoutEl = document.getElementById("logoutLink");
          freshLogoutEl.addEventListener("click", async (e) => {
            e.preventDefault();
            await supabase
              .from("user_presence")
              .delete()
              .eq("user_id", user.id);
            await supabase.auth.signOut();
            window.location.href = "login.html";
          });

          // permissions
          const { data: perms } = await supabase
            .from("user_permissions")
            .select("module_id,can_view")
            .eq("user_id", user.id);
          const permMap = Object.fromEntries(
            (perms || []).map((p) => [p.module_id, p.can_view])
          );
          document.querySelectorAll("a.module-link").forEach((a) => {
            // hide only if explicitly denied; placeholders remain visible but disabled
            const canView = permMap[a.dataset.moduleId];
            if (canView === false) a.style.display = "none";
          });
        } catch (err) {
          console.error("initApp error", err);
          const userInfoEl = document.getElementById("userInfo");
          if (userInfoEl) userInfoEl.textContent = "Error loading user";
        }
      }

      window.addEventListener("DOMContentLoaded", initApp);
    </script>
    <script>
      window.addEventListener("DOMContentLoaded", async () => {
        try {
          const v = await window.electronAPI.getAppVersion();
          document.getElementById("appVersion").textContent = `v${v}`;
        } catch (err) {
          console.error("Could not obtain app version:", err);
        }
      });
    </script>
  </body>
</html>
